<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Sistema Financeiro Avan√ßado</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
    :root{
      --bg:#f0f2f5; --card:#fff; --accent:#2ecc71; --danger:#e74c3c; --primary:#3498db;
      --text:#333; --text-muted:#555; --thead:#2c3e50; --stripe:#f2f2f2; --shadow:0 4px 15px rgba(0,0,0,0.1);
    }
    /* Dark mode vars */
    .dark{
      --bg:#0f141a; --card:#121a22; --accent:#23c36b; --danger:#ef4444; --primary:#3b82f6;
      --text:#e5e7eb; --text-muted:#9ca3af; --thead:#0b1117; --stripe:#0c1722; --shadow:0 6px 20px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:'Roboto',sans-serif; background:var(--bg); color:var(--text);}
    
    /* Overlay de Login */
    #login-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: linear-gradient(135deg, #0f2027, #2c5364);
      display: flex; align-items: center; justify-content: center; z-index: 10000;
    }
    .login-box {
      background: #fff; padding: 40px; border-radius: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      width: 90%; max-width: 350px; text-align: center;
    }
    .login-box input {
      width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;
    }
    .login-box button {
      width: 100%; padding: 12px; background: #2ecc71; color: white; border: none; 
      border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;
    }
    #app-wrapper { display: none; } /* Esconde tudo at√© logar */

    header{
      background: linear-gradient(90deg,#0f2027,#203a43,#2c5364);
      color:#fff; padding:16px 20px; display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    header h1{font-size:22px; margin:0; font-weight:700;}
    .header-actions{display:flex; flex-wrap:wrap; gap:8px}
    .btn{
      background:var(--primary); color:#fff; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; box-shadow:var(--shadow);
      display:inline-flex; align-items:center; gap:8px; font-weight:700
    }
    .btn.secondary{ background:#64748b }
    .btn.accent{ background:var(--accent) }
    .btn.danger{ background:var(--danger) }
    .btn:hover{ filter:brightness(.95) }
    .container{ max-width:1200px; margin:auto; padding:20px; }

    .dashboard{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:20px; }
    .card{ background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:18px; transition: transform .2s; text-align:center; }
    .card:hover{ transform: translateY(-4px) }
    .card h3{ margin:0 0 8px; font-size:14px; color:var(--text-muted) }
    .card p{ font-size:22px; font-weight:800; margin:0 }

    .transaction-form{
      background:var(--card); padding:16px; border-radius:14px; margin-bottom:12px; box-shadow:var(--shadow);
      display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      align-items:end;
    }
    .transaction-form input, .transaction-form select, .transaction-form button{
      padding:10px; border-radius:10px; border:1px solid #2b2f3680; background:transparent; color:var(--text)
    }
    .transaction-form input[type="number"]{ text-align:right }
    .transaction-form button{ background:var(--accent); color:white; border:none; cursor:pointer; transition:.2s; font-weight:700 }
    .transaction-form button:hover{ filter:brightness(.95) }

    .row-actions{ display:flex; flex-wrap:wrap; gap:10px; margin:14px 0 6px }
    .filters{ display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 18px }
    .filters input, .filters select, .filters button{ padding:8px; border-radius:10px; border:1px solid #2b2f3680; background:transparent; color:var(--text) }
    .filters .grow{ flex:1 1 220px }

    /* Melhora Responsividade Tabela */
    .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table{ width:100%; border-collapse:collapse; background:var(--card); border-radius:14px; overflow:hidden; box-shadow:var(--shadow); margin-bottom:16px }
    th, td{ padding:12px; text-align:left; min-width: 100px; }
    th{ background:var(--thead); color:white; font-weight:800 }
    tr:nth-child(even){ background:var(--stripe) }
    .income{ color:#22c55e; font-weight:800 }
    .expense{ color:#ef4444; font-weight:800 }
    .status-select{ border:none; font-weight:700; width:100%; background:transparent; cursor:pointer; color:inherit }
    .export-btn, #toggle-charts{ background:var(--primary); color:white; padding:10px 15px; border:none; border-radius:10px; cursor:pointer; margin-bottom:12px; box-shadow:var(--shadow) }
    .export-btn:hover, #toggle-charts:hover{ filter:brightness(.93) }
    .charts-row{ display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin-bottom:24px }
    .chart-box{ background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:14px; flex:1 1 360px; min-width:300px; max-width:520px }
    .chart-box canvas{ width:100% !important; height:300px !important }
    #monthly-chart{ max-height:320px !important; margin-bottom:20px; width:100% !important }
    tfoot td{ font-weight:800 }

    .anual { background:var(--card); border-radius:14px; box-shadow:var(--shadow); padding:44px; flex:1 1 360px; min-width:100%; max-width:100%; font-size: 10px; }
    
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800 }
    .pill.pago{ background:#16a34a1a; color:#22c55e; border:1px solid #22c55e50 }
    .pill.pendente{ background:#f59e0b1a; color:#f59e0b; border:1px solid #f59e0b50 }
    .pill.atrasado{ background:#ef44441a; color:#ef4444; border:1px solid #ef444450 }

    .hint{ font-size:12px; color:var(--text-muted); margin-top:-6px; margin-bottom:8px }
    
    @media (max-width:700px){ 
      .transaction-form{ grid-template-columns:1fr 1fr } 
      header h1 { font-size: 16px; }
      .btn { padding: 6px 8px; font-size: 12px; }
    }
  </style>
</head>
<body>

<div id="login-overlay">
  <div class="login-box">
    <h2 style="color: #333">Acesso ARNALDO</h2>
    <input type="text" id="user_login" placeholder="Usu√°rio">
    <input type="password" id="user_pass" placeholder="Senha">
    <button onclick="realizarLogin()">Entrar</button>
  </div>
</div>

<div id="app-wrapper">
  <header>
    <h1>Sistema de Controle Financeiro</h1>
    <div class="header-actions">
      <button id="theme-toggle" class="btn secondary" title="Alternar tema (Dark/Light)">üåó Tema</button>
      <button id="toggle-charts" class="btn secondary">üìà Mostrar Gr√°ficos</button>
      <button id="quick-report" class="btn accent">üßæ Relat√≥rio Todos os Registros (PDF)</button>
      <button id="open-access" class="btn accent">üîë Acessos</button>
      <button id="open-comprovantes">Abrir Comprovantes</button>
    </div>
  </header>

  <div class="container">
    <div class="dashboard">
      <div class="card"><h3>Saldo Atual</h3><p id="balance">R$ 0,00</p></div>
      <div class="card"><h3>Total Receitas</h3><p id="total-income">R$ 0,00</p></div>
      <div class="card"><h3>Total Despesas</h3><p id="total-expense">R$ 0,00</p></div>
      <div class="card"><h3>Despesas Pendentes</h3><p id="pending-count">0</p></div>
    </div>

    <div class="transaction-form" id="tx-form">
      <div><input type="text" id="description" placeholder="Descri√ß√£o da D√≠vida" required /><div class="hint"></div></div>
      <div><input type="number" id="amount" placeholder="Valor da D√≠vida (R$)" required step="0.01" min="0" /><div class="hint"></div></div>
      <div><select id="type"><option value="income">Receita</option><option value="expense">Despesa</option></select><div class="hint"></div></div>
      <div><select id="category"><option value="salario">Sal√°rio</option><option value="alimentacao">Alimenta√ß√£o</option><option value="transporte">Transporte</option><option value="Farm√°cia">Farm√°cia</option><option value="Empr√©stimo">Empr√©stimo</option><option value="lazer">Lazer</option><option value="outros">Outros</option></select><div class="hint"></div></div>
      <div><input type="date" id="date" required /><div class="hint"></div></div>
      <div><input type="number" id="installments" placeholder="QTD Parcelas (opicional)" min="1" /><div class="hint"></div></div>
      <div><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="is-recurring" /> Tornar mensal</label><div class="hint"></div></div>
      <button id="add-transaction">Registrar</button>
    </div>

    <div class="row-actions">
      <button class="btn" id="export-csv">Exportar CSV</button>
      <button class="btn" id="export-xlsx">Exportar Excel</button>
      <button class="btn" id="export-pdf">Exportar PDF (Filtrado)</button>
      <button class="btn secondary" id="backup-local">Backup Local</button>
      <button class="btn secondary" id="restore-local">Restaurar Backup</button>
      <button class="btn danger" id="clear-all">Limpar Tudo</button>
    </div>

    <div class="filters">
      <input type="date" id="filter-start" />
      <input type="date" id="filter-end" />
      <select id="filter-type"><option value="all">Todos</option><option value="income">Receitas</option><option value="expense">Despesas</option></select>
      <select id="filter-category"><option value="all">Todas Categorias</option><option value="salario">Sal√°rio</option><option value="alimentacao">Alimenta√ß√£o</option><option value="transporte">Transporte</option><option value="Farm√°cia">Farm√°cia</option><option value="Empr√©stimo">Empr√©stimo</option><option value="lazer">Lazer</option><option value="outros">Outros</option></select>
      <input id="search" class="grow" type="search" placeholder="Buscar por descri√ß√£o (tempo real)..." />
      <button id="apply-filters">Filtrar</button>
    </div>

    <div id="charts-container" class="charts-row" style="display:none;">
      <div class="chart-box"><canvas id="chart"></canvas></div>
      <div class="chart-box"><canvas id="status-chart"></canvas></div>
      <div class="chart-box"><canvas id="category-chart"></canvas></div>
    </div>

    <div class="anual" style="margin-bottom:18px;"><canvas id="monthly-chart"></canvas></div>

    <div class="table-responsive">
      <table>
        <thead><tr><th>Descri√ß√£o</th><th>Valor</th><th>Tipo</th><th>Categoria</th><th>Data</th><th>Status</th><th>A√ß√µes</th></tr></thead>
        <tbody id="transactions-table"></tbody>
        <tfoot><tr><td colspan="7" id="table-summary">0 itens ‚Ä¢ Receitas: R$ 0,00 ‚Ä¢ Despesas: R$ 0,00 ‚Ä¢ Saldo (vis√£o): R$ 0,00</td></tr></tfoot>
      </table>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

<script>
/* ===================== LOGICA DE LOGIN ===================== */
function realizarLogin() {
  const user = document.getElementById('user_login').value;
  const pass = document.getElementById('user_pass').value;
  if(user === "ARNALDO" && pass === "61892903377") {
    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('app-wrapper').style.display = 'block';
    loadTransactions(); // Carrega ap√≥s o login
    setTimeout(applyRecurrences, 600);
  } else {
    alert("Usu√°rio ou Senha inv√°lidos!");
  }
}

/* ===================== CONFIG FIREBASE (IGUAL) ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyDXDB6jbRy3o1eXcdXqmd8zrplDk1IezqM",
  authDomain: "sistema-financeiro-51295.firebaseapp.com",
  projectId: "sistema-financeiro-51295",
  storageBucket: "sistema-financeiro-51295.appspot.com",
  messagingSenderId: "340721821688",
  appId: "1:340721821688:web:77485712a056405f5f180d",
  measurementId: "G-X30NBWCY92",
  databaseURL: "https://sistema-financeiro-51295-default-rtdb.firebaseio.com"
};

let useFirebase = false; let db = null;
try { firebase.initializeApp(firebaseConfig); db = firebase.database(); useFirebase = true; console.log('Firebase conectado'); } catch (e) { console.warn('Firebase off'); }

/* ===================== ELEMENTOS UI ===================== */
const balanceEl = document.getElementById('balance');
const totalIncomeEl = document.getElementById('total-income');
const totalExpenseEl = document.getElementById('total-expense');
const pendingCountEl = document.getElementById('pending-count');
const transactionsTable = document.getElementById('transactions-table');
const addTransactionBtn = document.getElementById('add-transaction');
const exportCsvBtn = document.getElementById('export-csv');
const exportXlsxBtn = document.getElementById('export-xlsx');
const exportPdfBtn = document.getElementById('export-pdf');
const quickReportBtn = document.getElementById('quick-report');
const toggleChartsBtn = document.getElementById('toggle-charts');
const chartsContainer = document.getElementById('charts-container');
const filterStart = document.getElementById('filter-start');
const filterEnd = document.getElementById('filter-end');
const filterType = document.getElementById('filter-type');
const filterCategory = document.getElementById('filter-category');
const searchInput = document.getElementById('search');
const themeToggle = document.getElementById('theme-toggle');
const tableSummary = document.getElementById('table-summary');
const backupBtn = document.getElementById('backup-local');
const restoreBtn = document.getElementById('restore-local');
const clearAllBtn = document.getElementById('clear-all');

let transactions = []; let editMode = false; let editKey = null;

/* ===================== UTILIT√ÅRIOS (IGUAL) ===================== */
function formatCurrency(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(Number(v) || 0); }
function formatDateBR(dStr) { if (!dStr) return ""; const [y, m, d] = dStr.split("-"); return `${d}/${m}/${y}`; }
function addMonths(dStr, n) { if (!dStr) return ""; const [y, m, d] = dStr.split("-").map(Number); const newDate = new Date(y, m - 1 + n, d); return `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, "0")}-${String(newDate.getDate()).padStart(2, "0")}`; }
function getStatus(t) { if (t.type === 'income') return 'Pago'; if (t.status) return t.status; const today = new Date().toISOString().split('T')[0]; return t.date < today ? 'Atrasado' : 'Pendente'; }
function toast(m){ const el = document.createElement('div'); el.textContent = m; el.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;z-index:9999;font-weight:800'; document.body.appendChild(el); setTimeout(()=> el.remove(), 2200); }

/* ===================== PERSIST√äNCIA (IGUAL) ===================== */
function loadTransactions() {
  if (useFirebase && db) {
    db.ref('transactions').on('value', snapshot => {
      const val = snapshot.val();
      transactions = val ? Object.entries(val).map(([k, v]) => ({ _key: k, ...v })) : [];
      refreshAll();
    });
  } else { loadFromLocal(); }
}
function loadFromLocal() { transactions = JSON.parse(localStorage.getItem('transactions_backup') || '[]'); refreshAll(); }
function saveLocal(){ localStorage.setItem('transactions_backup', JSON.stringify(transactions)); }

/* ===================== CRUD (IGUAL) ===================== */
function saveTransaction(data) {
  if (useFirebase && db) { if (editMode && editKey) { db.ref(`transactions/${editKey}`).update(data); } else { db.ref('transactions').push(data); } }
  else { if (editMode && editKey) { const idx = transactions.findIndex(t => t._key === editKey); if (idx >= 0) transactions[idx] = { ...transactions[idx], ...data }; } else { data._key = String(Date.now()); transactions.push(data); } saveLocal(); }
  resetForm(); refreshAll();
}
function deleteTransaction(key) { if (!confirm('Confirmar exclus√£o?')) return; if (useFirebase && db) { db.ref(`transactions/${key}`).remove(); } else { transactions = transactions.filter(t => t._key !== key); saveLocal(); refreshAll(); } }
function updateStatus(key, status) { if (useFirebase && db) { db.ref(`transactions/${key}`).update({ status }); } else { const trans = transactions.find(t => t._key === key); if (trans) trans.status = status; saveLocal(); refreshAll(); } }
function editTransaction(key) {
  const t = transactions.find(t => t._key === key); if (!t) return;
  document.getElementById('description').value = t.description; document.getElementById('amount').value = t.amount; document.getElementById('type').value = t.type; document.getElementById('category').value = t.category; document.getElementById('date').value = t.date; document.getElementById('is-recurring').checked = !!t.isRecurring;
  editMode = true; editKey = key; addTransactionBtn.textContent = 'Atualizar'; toast('Modo edi√ß√£o ativo');
}

/* ===================== RENDERIZA√á√ÉO (IGUAL) ===================== */
function renderTable(data = transactions) {
  transactionsTable.innerHTML = '';
  data.forEach(t => {
    const tr = document.createElement('tr');
    const status = getStatus(t);
    const statusHtml = (t.type === 'expense') ? `<select class="status-select" onchange="updateStatus('${t._key}', this.value)"><option value="Pendente" ${status==='Pendente'?'selected':''}>Pendente</option><option value="Pago" ${status==='Pago'?'selected':''}>Pago</option><option value="Atrasado" ${status==='Atrasado'?'selected':''}>Atrasado</option></select>` : `<span class="pill pago">Pago</span>`;
    tr.innerHTML = `<td>${t.description}${t.installmentInfo ? ` <span class="pill secondary">${t.installmentInfo}</span>`:''}</td><td class="${t.type==='income'?'income':'expense'}">${formatCurrency(t.amount)}</td><td>${t.type}</td><td>${t.category}</td><td>${formatDateBR(t.date)}</td><td>${statusHtml}</td><td><button class="btn secondary" onclick="editTransaction('${t._key}')">Editar</button><button class="btn danger" onclick="deleteTransaction('${t._key}')">Excluir</button></td>`;
    transactionsTable.appendChild(tr);
  });
}
function updateDashboard(data = transactions) {
  const inc = data.filter(t => t.type === 'income').reduce((s, t) => s + Number(t.amount), 0);
  const exp = data.filter(t => t.type === 'expense').reduce((s, t) => s + Number(t.amount), 0);
  balanceEl.textContent = formatCurrency(inc - exp); totalIncomeEl.textContent = formatCurrency(inc); totalExpenseEl.textContent = formatCurrency(exp); pendingCountEl.textContent = data.filter(t => t.type==='expense' && ['Pendente','Atrasado'].includes(getStatus(t))).length;
  tableSummary.textContent = `${data.length} itens ‚Ä¢ Saldo: ${formatCurrency(inc - exp)}`;
}

/* ===================== FILTROS (IGUAL) ===================== */
function applyFilters() {
  let filtered = transactions.slice();
  const start = filterStart.value, end = filterEnd.value, type = filterType.value, cat = filterCategory.value, q = searchInput.value.toLowerCase();
  if (start) filtered = filtered.filter(t => t.date >= start); if (end) filtered = filtered.filter(t => t.date <= end);
  if (type !== 'all') filtered = filtered.filter(t => t.type === type); if (cat !== 'all') filtered = filtered.filter(t => t.category === cat);
  if (q) filtered = filtered.filter(t => t.description.toLowerCase().includes(q));
  renderTable(filtered); updateDashboard(filtered); 
  if (chartsContainer.style.display !== 'none') { updateCharts(filtered); updateMonthlyChart(filtered); }
  return filtered;
}

/* ===================== ADICIONAR (IGUAL) ===================== */
function addTransaction() {
  const desc = document.getElementById('description').value, amount = parseFloat(document.getElementById('amount').value), type = document.getElementById('type').value, cat = document.getElementById('category').value, date = document.getElementById('date').value, inst = parseInt(document.getElementById('installments').value || '0'), rec = document.getElementById('is-recurring').checked;
  if (!desc || isNaN(amount) || !date) return alert('Campos vazios!');
  if (editMode && editKey) { saveTransaction({ description: desc, amount, type, category: cat, date, isRecurring: rec }); return; }
  if (inst > 1) { for (let i=0; i<inst; i++) { saveTransaction({ description: `${desc} (${i+1}/${inst})`, amount, type, category: cat, date: addMonths(date, i), installmentInfo: `${i+1}/${inst}`, isRecurring: false }); } }
  else { saveTransaction({ description: desc, amount, type, category: cat, date, isRecurring: rec }); }
}

function resetForm() { editMode = false; editKey = null; addTransactionBtn.textContent = 'Registrar'; document.getElementById('description').value = ''; document.getElementById('amount').value = ''; }

/* ===================== GR√ÅFICOS (IGUAL) ===================== */
Chart.register(ChartDataLabels);
function updateCharts(data) {
  const inc = data.filter(t=>t.type==='income').reduce((a,b)=>a+Number(b.amount),0), exp = data.filter(t=>t.type==='expense').reduce((a,b)=>a+Number(b.amount),0);
  const ctx = document.getElementById('chart').getContext('2d');
  if (window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Receitas', 'Despesas'], datasets: [{ data: [inc, exp], backgroundColor: ['#2ecc71', '#e74c3c'] }] } });
}
function updateMonthlyChart(data) {
  const months = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  const incM = Array(12).fill(0), expM = Array(12).fill(0);
  data.forEach(t => { const d = new Date(t.date); if(!isNaN(d)) { const m = d.getMonth(); t.type === 'income' ? incM[m]+=Number(t.amount) : expM[m]+=Number(t.amount); } });
  const ctx = document.getElementById('monthly-chart').getContext('2d');
  if (window.mChart) window.mChart.destroy();
  window.mChart = new Chart(ctx, { type: 'line', data: { labels: months, datasets: [{ label: 'Receitas', data: incM, borderColor: '#2ecc71' }, { label: 'Despesas', data: expM, borderColor: '#e74c3c' }] } });
}

/* ===================== EXPORTA√á√ïES (IGUAL) ===================== */
function exportPDF(allData, filename='relatorio.pdf'){
  const { jsPDF } = window.jspdf; const doc = new jsPDF({orientation:'l'});
  const rows = allData.map(t => [t.description, formatCurrency(t.amount), t.type, t.category, formatDateBR(t.date), getStatus(t)]);
  doc.autoTable({ head: [['Descri√ß√£o','Valor','Tipo','Categoria','Data','Status']], body: rows });
  doc.save(filename);
}

/* ===================== RECORRENCIA (IGUAL) ===================== */
function applyRecurrences(){
  const now = new Date(); const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  transactions.filter(t => t.isRecurring).forEach(t => {
    if (!transactions.some(x => x.description === t.description && x.date.startsWith(ym))) {
      saveTransaction({ ...t, date: `${ym}-${t.date.split('-')[2]}`, _key: null });
    }
  });
}

function refreshAll() { applyFilters(); }

/* ===================== EVENTOS (IGUAL) ===================== */
addTransactionBtn.addEventListener('click', addTransaction);
document.getElementById('apply-filters').addEventListener('click', applyFilters);
themeToggle.addEventListener('click', () => { document.body.classList.toggle('dark'); });
toggleChartsBtn.addEventListener('click', () => { chartsContainer.style.display = (chartsContainer.style.display==='none') ? 'flex' : 'none'; refreshAll(); });
quickReportBtn.addEventListener('click', () => exportPDF(transactions, 'completo.pdf'));
exportPdfBtn.addEventListener('click', () => exportPDF(applyFilters(), 'filtrado.pdf'));
backupBtn.addEventListener('click', () => { saveLocal(); toast('Backup Local OK'); });
restoreBtn.addEventListener('click', () => { loadFromLocal(); toast('Restaurado'); });
clearAllBtn.addEventListener('click', () => { if(confirm('Limpar tudo?')){ if(useFirebase) db.ref('transactions').remove(); else {transactions=[]; saveLocal(); refreshAll();} } });
document.getElementById('open-access').addEventListener('click', () => { window.location.href = 'acessos.html'; });
document.getElementById('open-comprovantes').addEventListener('click', () => { window.location.href = 'comprovantes.html'; });

// Impede carregar dados antes do login real
window.onload = () => { 
  const t = localStorage.getItem('theme'); if(t==='dark') document.body.classList.add('dark');
  const now = new Date();
  filterStart.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`;
};
</script>
</body>
</html>
