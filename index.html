
<!DOCTYPE html>
<!--/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner       ATECSEVEN TECNOLOGIA
 * @cnpj        63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */-->
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>edu10 Avalia√ß√µes - Gerador de Provas</title>
    <!--/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner       ATECSEVEN TECNOLOGIA
 * @cnpj        63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */-->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    
    <style>
    /* 1. SISTEMA DE DESIGN (INTERFACE DO USU√ÅRIO) */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    :root {
        --primary-color: #3f51b5;
        --primary-dark: #303f9f;
        --secondary-color: #f44336;
        --background-color: #f4f7f6;
        --card-bg: #ffffff;
        --text-color: #1e293b;
        --border-color: #e2e8f0;
        --radius: 8px;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --transition: all 0.2s ease;
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', 'Arial', sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
    }

    .container {
        display: flex;
        min-height: 100vh;
    }

    /* LOGIN */
    #login-screen {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        width: 100vw;
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
    }
    .login-box {
        width: 380px;
        padding: 40px;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        text-align: center;
    }
    .login-box h2 {
        color: var(--primary-color);
        margin-bottom: 8px;
        font-weight: 700;
    }
    .login-box p {
        font-size: 0.9em;
        color: #64748b;
        margin-bottom: 24px;
    }
    .login-box input {
        width: 100%;
        padding: 12px;
        margin-bottom: 16px;
        border-radius: 6px;
        border: 1px solid #ddd;
        transition: var(--transition);
    }
    .login-box input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.1);
    }

    /* BOT√ïES */
    .btn-primary, .btn-secondary, .btn-danger, .btn-success, .btn-warning {
        padding: 10px 18px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 600;
        margin-right: 5px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    .btn-primary { background-color: var(--primary-color); color: white; }
    .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-1px); }
    .btn-secondary { background-color: #64748b; color: white; }
    .btn-secondary:hover { background-color: #475569; }
    .btn-danger { background-color: var(--secondary-color); color: white; }
    .btn-danger:hover { background-color: #d32f2f; }
    .btn-success { background-color: #10b981; color: white; }
    .btn-warning { background-color: #f59e0b; color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.85em; }

    /* INTERFACE PRINCIPAL */
    #main-interface {
        display: none;  
        flex-direction: column;
        width: 100%;
    }
    
    header {
        background-color: var(--card-bg);
        color: black;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
    }
    header h1 {
        margin: 0;
        font-size: 1.4em;
        font-weight: 700;
    }
    #user-role-display {
        font-size: 0.75em;
        background: #e0e7ff;
        color: var(--primary-color);
        padding: 4px 10px;
        border-radius: 4px;
        font-weight: 600;
    }

    .nav-menu {
        list-style: none;
        padding: 0;
        margin: 0;
        background: #1B263B;
        display: flex;
    }
    .nav-menu li a {
        display: block;
        padding: 14px 24px;
        color: #cbd5e1;
        text-decoration: none;
        transition: var(--transition);
        font-weight: 500;
        font-size: 0.95em;
    }
    .nav-menu li a:hover, .nav-menu li a.active {
        color: black;
        background-color: var(--primary-color);
    }

    .page-section {
        display: none;  
        padding: 30px;
        flex-grow: 1;
        max-width: 1200px;
        margin: 24px auto;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }
    .page-section h2 {
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
        margin-bottom: 25px;
        color: var(--primary-color);
        font-weight: 700;
    }
    
    /* FORMUL√ÅRIOS DA INTERFACE */
    .page-section form label {
        display: block;
        margin-top: 15px;
        margin-bottom: 6px;
        font-weight: 600;
        font-size: 0.9em;
    }
    .page-section form input:not([type="checkbox"]),
    .page-section form select,
    .page-section form textarea,
    .modal-content form input:not([type="file"]):not([type="checkbox"]):not([type="radio"]),
    .modal-content form select,
    .modal-content form textarea {
        width: 100%;
        padding: 11px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        margin-bottom: 12px;
        font-size: 0.95em;
    }

    .dashboard-grid {
    display: grid;
    /* Define 4 colunas iguais por padr√£o. Se tiver 3 ou 5 cards, mude o n√∫mero 4 */
    grid-template-columns: repeat(auto-flow, minmax(0, 1fr)); 
    /* Alternativamente, para for√ßar sempre uma linha independente do n√∫mero de cards: */
    grid-auto-flow: column;
    grid-auto-columns: 1fr;
    
    gap: 15px;
    margin-bottom: 15px;
    width: 100%;
    overflow-x: auto; /* Adiciona scroll horizontal sutil se a tela for MUITO pequena */
}

.indicator-card {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    box-shadow: var(--shadow-md);
    min-width: 150px; /* Impede que o card fique ileg√≠vel em telas pequenas */
}

.indicator-card h3 {
    margin: 0;
    font-size: 1.8em; /* Reduzi levemente para caber melhor em uma linha s√≥ */
    font-weight: 700;
}

.indicator-card p {
    margin: 5px 0 0;
    font-size: 0.85em;
    opacity: 0.9;
    white-space: nowrap; /* Evita que o texto do r√≥tulo quebre linha */
}

    .exam-list li, #questions-bank-list li, .user-list li {
        padding: 18px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .exam-list li:hover { background-color: #f8fafc; }

    .filter-container {
        margin-bottom: 24px;
        padding: 18px;
        background: #f1f5f9;
        border-radius: 8px;
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    /* ALERTAS */
    .alert-error { background-color: #fef2f2; color: #991b1b; border: 1px solid #fecaca; padding: 12px; border-radius: 6px; margin-bottom: 15px;}
    .alert-success { background-color: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; padding: 12px; border-radius: 6px; margin-bottom: 15px;}

    /* MODAL */
    .modal {
        display: none;  
        position: fixed;    
        z-index: 1000;  
        left: 0;
        top: 0;
        width: 100%;    
        height: 100%;   
        overflow: auto; 
        background-color: rgba(15, 23, 42, 0.6);   
        padding-top: 60px;
    }
    .modal-content {
        background-color: var(--card-bg);
        margin: 2% auto;    
        padding: 32px;
        width: 85%; 
        max-width: 900px;
        border-radius: 12px;
        position: relative;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
    }

    #exam-preview {
        border: 1px solid #ddd;
        padding: 20px; 
        background: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        max-width: 210mm;   
        margin: 20px auto;  
        min-height: 297mm;
        font-family: 'Times New Roman', serif; /* Mantido fixo */
    }
    
    #exam-content-print {
        padding: 10px;
    }
    #exam-content-print .exam-header-print {
        border: 1px solid #000;
        padding: 0; 
        margin-bottom: 20px;
        display: grid;
        grid-template-columns: 20% 80%; 
        font-size: 10pt;
    }
    #exam-content-print .exam-header-print table {
         width: 100%; 
         border-collapse: collapse; 
         font-size: 10pt;
    }
    #exam-content-print .exam-header-print table,
    #exam-content-print .exam-header-print td {
        border: 1px solid #000;
    }
    #exam-content-print .exam-header-print td {
        padding: 3px 5px;
    }
    #exam-content-print .exam-header-print .logo-area {
        border: 1px solid #000; 
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 5px;
    }
    #exam-content-print .exam-header-print .logo-area img {
        max-width: 100%;
        max-height: 50px;
        height: auto;
    }
    #exam-content-print .questions-wrapper {
         column-count: 1; 
         gap: 20px;
    }
    #exam-content-print .question-item-print {
         border: 1px solid #ddd;
         padding: 10px;
         margin-bottom: 15px;
    }
    #exam-content-print .q-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         background-color: #fff8e1; 
         padding: 5px;
         margin: -10px -10px 10px -10px;
         border-bottom: 1px solid #ccc;
    }
    #exam-content-print .q-header strong {
         font-size: 12pt;
         color: #3f51b5;
    }
    #exam-content-print .q-enunciado {
         font-size: 11pt;
         margin-bottom: 10px;
    }
    #exam-content-print .alternative-list-print {
         list-style: none;
         padding: 0;
         margin: 0;
    }
    #exam-content-print .alternative-list-print li label {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 11pt;
    }
    #exam-content-print .alternative-list-print input[type="checkbox"] {
        margin-right: 10px;
        transform: scale(1.2);
    }

 
    #print-area-container {
        display: none; 
        font-family: 'Times New Roman', serif;
    }

    .af-garbage {
        position: absolute;
        opacity: 0;
        color: transparent;
        font-size: 1px;
        width: 1px;
        height: 1px;
        overflow: hidden;
        pointer-events: none;
        z-index: -999;
    }
    
    @media print {
        @page {
            size: A4;
            margin: 18mm 15mm 15mm 18mm; 
            
            @bottom-right {
                content: "P√°gina " counter(page) " de " counter(pages);
                font-size: 9pt;
                font-family: 'Times New Roman', serif;
                color: #000;
            }
            
            @bottom-left {
                content: "By Atecseven tecnologia - www.atecseven.com.br - CNPJ 63.373.374/0001-72";
                font-size: 8pt;
                font-family: 'Times New Roman', serif;
                color: #555;
            }
        }
        
        body {
            background: none !important;
            color: black !important;
            margin: 0 !important;
            padding: 0 !important;
            font-size: 11pt !important;    
            line-height: 1.4 !important;
            font-family: 'Times New Roman', serif !important;
        }

        body > *:not(#print-area-container) {
            display: none !important;
        }
        
        #print-area-container {
            display: block !important;
            width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
        }

        .exam-header-print {
            border: 1px solid #000 !important; 
            padding: 0 !important;
            margin-bottom: 15px !important;
            display: grid !important;
            grid-template-columns: 20% 80% !important; 
            break-after: avoid; 
            page-break-after: avoid;
        }
        .exam-header-print .logo-area {
            border: none !important; 
            border-right: 1px solid #000 !important; 
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
        }
        .exam-header-print .logo-area img {
            max-width: 100%;
            max-height: 70px;
        }
        .exam-header-print table {
            border-collapse: collapse !important;
            width: 100% !important;
            height: 100% !important;
        }
        .exam-header-print table, .exam-header-print td {
            border: none !important;
        }
        .exam-header-print td {
            border-top: 1px solid #000 !important; 
            border-left: 1px solid #000 !important;
            padding: 3px 5px !important;
            font-size: 9pt !important;
            vertical-align: top !important;
        }
        .exam-header-print > div:nth-child(2) > table > tbody > tr:first-child > td {
             border-top: none !important;
         }
        .exam-header-print > div:nth-child(2) > table > tbody > tr > td:first-child {
            border-left: none !important;
        }
        
        .instructions-text {
            font-size: 9pt !important;
            margin-bottom: 10px !important; 
            padding: 5px 10px !important;
            border: 1px solid #000 !important;
            text-align: justify !important;
        }

        .questions-wrapper {
            column-count: var(--print-col-count, 1) !important; 
            column-gap: 15mm !important;
            column-rule: 1px solid #ccc !important;
            page-break-after: auto;
        }
        .question-item-print {
            margin-bottom: 10px !important;
            padding: 0 !important; 
            border: none !important;
            break-inside: avoid-column !important; 
            page-break-inside: avoid !important;
        }
        .q-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            background-color: transparent !important; 
            padding: 3px 0 !important;
            margin: 0 0 5px 0 !important;
            border-bottom: 1px dotted #ccc !important; 
        }
        .q-header strong {
            font-size: 11pt !important;
            font-weight: bold !important;
            color: #333 !important;
        }
        .q-enunciado {
            font-size: 10.5pt !important;
            margin: 5px 0 5px 5px !important; 
            text-align: justify !important;
        }
        
        .image-preview { 
            max-width: 60% !important; 
            height: auto !important; 
            margin: 8px 0 !important; 
        }

        .discursiva-answer-space {
            border: 1px dashed #aaa !important;    
            margin-top: 5px !important; 
            padding: 5px !important;
        }
    }

    footer {
        padding: 20px;
        text-align: center;
        font-size: 0.8em;
        color: #94a3b8;
        border-top: 1px solid var(--border-color);
        margin-top: auto;
    }
</style>
</head>
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <img src="img/logo-edu10.jpeg" alt="Logo" id="loading-logo" class="loading-logo">
        
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        
        <p id="education-quote" class="education-quote">"Carregando sabedoria..."</p>
        <span class="loading-status">Carregando ambiente...</span>
    </div>
</div>

<div id="update-toast" class="update-toast">
    <div class="toast-content">
        <i class="fas fa-rocket"></i>
        <span>Sistema atualizado! Nova vers√£o <b>2.1.0</b> dispon√≠vel.</span>
    </div>
</div>

<style>
    /* MODAL DE CARREGAMENTO */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f8fafc;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        transition: opacity 0.6s ease, visibility 0.6s;
    }

    .loading-content {
        text-align: center;
        width: 90%;
        max-width: 400px;
        transition: all 0.4s ease;
    }

    .loading-logo {
        max-height: 65px;
        margin-bottom: 30px;
        transition: all 0.3s cubic-bezier(0.6, -0.28, 0.735, 0.045); /* Efeito de encolhimento r√°pido */
        transform: scale(1);
    }

    /* Classe disparada pelo JS ao fim do load */
    .loading-logo.shrink {
        transform: scale(0);
        opacity: 0;
    }

    .progress-container {
        width: 100%;
        height: 6px;
        background: #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .progress-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #3f51b5, #6366f1);
        box-shadow: 0 0 10px rgba(63, 81, 181, 0.3);
        transition: width 0.3s ease;
    }

    .education-quote {
        font-family: 'Inter', sans-serif;
        font-style: italic;
        color: #64748b;
        font-size: 0.95rem;
        margin-bottom: 8px;
        min-height: 3rem;
    }

    .loading-status {
        font-family: 'Inter', sans-serif;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #94a3b8;
    }

    /* TOAST DE ATUALIZA√á√ÉO */
    .update-toast {
        position: fixed;
        top: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: #ffffff;
        color: #1e293b;
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        z-index: 9999;
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border: 1px solid #e2e8f0;
    }

    .update-toast.show { top: 25px; }
    
</style>

<script>
    const quotes = [
        '"A educa√ß√£o √© a arma mais poderosa que voc√™ pode usar para mudar o mundo." - Nelson Mandela',
        '"Ensinar n√£o √© transferir conhecimento, mas criar as possibilidades para a sua produ√ß√£o." - Paulo Freire',
        '"A educa√ß√£o tem ra√≠zes amargas, mas os seus frutos s√£o doces." - Arist√≥teles',
        '"Onde quer que voc√™ veja um neg√≥cio de sucesso, algu√©m tomou uma decis√£o corajosa." - Peter Drucker'
    ];

    document.addEventListener('DOMContentLoaded', function() {
        const overlay = document.getElementById('loading-overlay');
        const progressBar = document.getElementById('progress-bar');
        const logo = document.getElementById('loading-logo');
        const quoteElement = document.getElementById('education-quote');
        const toast = document.getElementById('update-toast');

        // Selecionar cita√ß√£o aleat√≥ria
        quoteElement.innerText = quotes[Math.floor(Math.random() * quotes.length)];

        let width = 0;
        const interval = setInterval(() => {
            if (width >= 100) {
                clearInterval(interval);
                
                // 1. Encolher a logo rapidamente
                logo.classList.add('shrink');

                // 2. Aguardar o efeito de encolhimento e fechar o modal
                setTimeout(() => {
                    overlay.style.opacity = '0';
                    overlay.style.visibility = 'hidden';
                    
                    // 3. Mostrar o Toast de vers√£o
                    setTimeout(() => {
                        toast.classList.add('show');
                        setTimeout(() => toast.classList.remove('show'), 5000);
                    }, 600);
                }, 300); 

            } else {
                width += Math.random() * 20; 
                if (width > 100) width = 100;
                progressBar.style.width = width + '%';
            }
        }, 250);
    });
</script>
<div id="login-screen">
    <style>
        /* Estilos restritos APENAS ao bloco de login */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f1f5f9;
            font-family: sans-serif;
        }

        #login-screen .login-box {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 15px;
            width: 100%;
            max-width: 360px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        #login-screen .login-box p {
            color: #64748b;
            margin-bottom: 25px;
            font-size: 0.9em;
        }

        /* Seletores espec√≠ficos para n√£o afetar outros inputs do site */
        #login-screen .login-box input[type="email"], 
        #login-screen .login-box input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background-color: #f8fafc;
            color: #1e293b;
            box-sizing: border-box;
            outline: none;
        }

        #login-screen .login-box input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Container do Interruptor */
        #login-screen .remember-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 5px 2px 20px 2px;
        }

        #login-screen .remember-text {
            font-size: 0.85em;
            color: #475569;
        }

        #login-screen .switch {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 20px;
        }

        #login-screen .switch input {
            opacity: 0; width: 0; height: 0;
        }

        #login-screen .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1;
            transition: .3s;
            border-radius: 20px;
        }

        #login-screen .slider:before {
            position: absolute;
            content: "";
            height: 14px; width: 14px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        #login-screen input:checked + .slider {
            background-color: #3b82f6;
        }

        #login-screen input:checked + .slider:before {
            transform: translateX(18px);
        }

        /* Bot√£o entrar mantendo sua classe original mas com estilo fixo aqui */
        #login-screen .btn-primary {
            width: 100%;
            padding: 13px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>

    <div class="login-box">
        <img src="img/logo-edu10.jpeg" alt="edu10" width="150" height="50">
        <p>Acesse com seu e-mail e senha.</p>
        
        <input type="email" id="login-user" placeholder="E-mail">
        <input type="password" id="login-password" placeholder="Senha">

        <div class="remember-wrapper">
            <span class="remember-text">Lembrar e-mail e senha</span>
            <label class="switch">
                <input type="checkbox" id="remember-check">
                <span class="slider"></span>
            </label>
        </div>

        <button class="btn-primary" onclick="handleLoginWithSave()">
            <i class="fas fa-sign-in-alt"></i> Entrar
        </button>
        
        <button class="btn-secondary" onclick="openModal('modal-request-access')" style="margin-top: 10px; width: 100%; border: 1px solid #e2e8f0; background: none; padding: 10px; border-radius: 8px; cursor: pointer; color: #64748b;">
            <i class="fas fa-user-plus"></i> Solicitar Acesso
        </button>
        
        <div id="login-message" style="margin-top: 15px;"></div>
    </div>

    <script>
        (function() {
            const m = localStorage.getItem('e10_m');
            const s = localStorage.getItem('e10_s');
            if (m && s) {
                document.getElementById('login-user').value = m;
                document.getElementById('login-password').value = s;
                document.getElementById('remember-check').checked = true;
            }
        })();

        function handleLoginWithSave() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-password').value;
            const c = document.getElementById('remember-check').checked;

            if (c && u && p) {
                localStorage.setItem('e10_m', u);
                localStorage.setItem('e10_s', p);
            } else {
                localStorage.removeItem('e10_m');
                localStorage.removeItem('e10_s');
            }

            // Chama sua fun√ß√£o handleLogin que j√° existe no seu c√≥digo principal
            if (typeof handleLogin === "function") {
                handleLogin();
            }
        }
    </script>
</div>
<!--/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner       ATECSEVEN TECNOLOGIA
 * @cnpj        63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */-->
   <div id="main-interface">
    <style>
        #main-interface {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff;
            width: 100%;
        }

        /* HEADER FIXO */
        #main-interface header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;

            background: #ffffff;
            padding: 12px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;

            box-shadow: 0 2px 10px white;
            /* Borda alterada de azul para branco */
            border-bottom: 2px solid #ffffff; 
            color:white; 
        }

        #main-interface #user-info-display {
            margin-left: 20px;
            font-size: 0.95rem;
            font-weight: 400;
            color: #444;
            border-left: 1px solid #ddd;
            padding-left: 15px;
        }

        #main-interface #user-role-display {
            /* Fundo e borda alterados para branco/neutro */
            background: #ffffff;
            color: #666;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-right: 15px;
            border: 1px solid #eee;
        }

        #main-interface .btn-danger {
            background: transparent;
            color: #ff4d4f;
            border: 1px solid #ff4d4f;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        #main-interface .btn-danger:hover {
            background: #ff4d4f;
            color: #fff;
            box-shadow: 0 0 10px rgba(255, 77, 79, 0.4);
        }

        /* NAV FIXO - FUNDO E BORDAS AGORA BRANCOS */
        #main-interface nav {
            position: fixed;
            top: 72px;
            left: 0;
            right: 0;
            z-index: 999;

            background: #ffffff; /* Fundo garantido como branco */
            box-shadow: 0 2px 6px white;
            border-bottom: 1px solid #ffffff; /* Linha de baixo branca */
        }

        #main-interface .nav-menu {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        #main-interface .nav-menu li {
            position: relative;
        }

        #main-interface .nav-menu a {
            display: block;
            padding: 18px 22px;
            text-decoration: none;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #main-interface .nav-menu a i {
            /* √çcones alterados de azul para cinza suave (para visibilidade) ou branco */
            color: #888; 
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }

        #main-interface .nav-menu a:hover {
            /* Hover alterado de azul para um branco levemente transl√∫cido */
            color: #111;
            background: rgba(255, 255, 255, 0.8);
        }

        #main-interface .nav-menu a:hover i {
            transform: translateY(-2px);
            color: #333;
        }

        #main-interface .nav-menu a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            /* Linha de anima√ß√£o alterada para branco */
            background: #ffffff;
            transition: all 0.4s ease;
            transform: translateX(-50%);
        }

        #main-interface .nav-menu a:hover::after {
            width: 80%;
        }

        /* ESPA√áADOR INTERNO */
        #main-interface .top-spacer {
            height: 125px;
        }

        @media (max-width: 900px) {
            #main-interface .nav-menu {
                flex-wrap: wrap;
            }
            #main-interface .nav-menu a {
                padding: 12px 15px;
                font-size: 0.8rem;
            }
            #main-interface .top-spacer {
                height: 150px;
            }
        }
</style>

    <header>
        <div style="display: flex; align-items: center;">
            <img src="img/logo-edu10.jpeg" alt="Edu10 Logo" width="150" height="50" style="object-fit: contain;">
            <span id="user-info-display">Ol√°, Professor(a)</span>
        </div>
        <div>
            <span id="user-role-display">Sess√£o Ativa</span>
            <button class="btn-danger" onclick="simularLogout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </header>

    <nav>
        <ul class="nav-menu">
            <li><a id="nav-dashboard" href="#" onclick="showPage('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a id="nav-createquestion" href="#" onclick="showPage('create-question')"><i class="fas fa-plus-circle"></i> Criar Quest√£o</a></li>
            <li><a id="nav-bank" href="#" onclick="showPage('bank')"><i class="fas fa-database"></i> Banco de Quest√µes</a></li>
            <li><a id="nav-createexam" href="#" onclick="showPage('create-exam')"><i class="fas fa-file-export"></i> Gerar Prova</a></li>
            <li><a id="nav-myexams" href="#" onclick="showPage('my-exams')"><i class="fas fa-clipboard-list"></i> Minhas Provas</a></li>
            <li id="nav-admin" style="display: none;"><a href="#" onclick="showPage('admin')"><i class="fas fa-user-shield"></i> Administra√ß√£o</a></li>
        </ul>
    </nav>

    <div class="top-spacer"></div>
</div>


        <main>
            <section id="dashboard" class="page-section">
                <h2><i class="fas fa-tachometer-alt"></i> Resumo do Sistema</h2>
                <div class="dashboard-grid">
                    <div class="indicator-card">
                        <p>Total de Quest√µes no Banco</p>
                        <h3 id="dash-total-questoes">0</h3>
                    </div>
                    <div class="indicator-card">
                        <p>Total de Provas Geradas</p>
                        <h3 id="dash-total-provas">0</h3>
                    </div>
                    <div class="indicator-card" style="background-color: #00bcd4;">
                        <p>Usu√°rios Padr√£o</p>
                        <h3 id="dash-total-padrao">0</h3>
                    </div>
                    <div class="indicator-card" style="background-color: #ff9800;">
                        <p>Usu√°rios ADM</p>
                        <h3 id="dash-total-adm">0</h3>
                    </div>
                    <div class="indicator-card" style="background-color: var(--secondary-color);">
                        <p>Usu√°rios Pendentes</p>
                        <h3 id="dash-total-pendentes">0</h3>
                    </div>
                </div>
            </section>

           <section id="create-question" class="page-section">
    <style>
        /* ISOLAMENTO TOTAL: Todas as regras come√ßam com o ID da section */
        #create-question {
            background: #ffffff;
            padding: 15px 25px;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            max-width: 100%;
            margin: 10px auto;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        /* T√≠tulos e Alertas compactos */
        #create-question h2 {
            font-size: 1.2rem;
            color: #1e293b;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #create-question .alert-info {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.8rem;
            color: #475569;
            margin-bottom: 15px;
        }

        /* Grid de alta densidade */
        #create-question .dashboard-grid {
            display: grid !important;
            gap: 15px;
            margin-bottom: 10px;
        }

        /* Estiliza√ß√£o dos inputs (apenas dentro desta section) */
        #create-question label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #334155;
            text-transform: uppercase;
            margin: 8px 0 4px 0;
        }

        #create-question input[type="text"],
        #create-question input[type="number"],
        #create-question select,
        #create-question textarea {
            width: 100% !important;
            padding: 8px 12px !important;
            border: 2px solid #cbd5e1 !important; /* Borda n√≠tida */
            border-radius: 6px !important;
            font-size: 0.9rem !important;
            color: #000 !important;
            background: #fff !important;
            box-sizing: border-box !important;
        }

        #create-question textarea {
            height: 100px; /* Enunciado compacto */
            resize: vertical;
        }

        /* Se√ß√£o de Alternativas */
        #create-question #alternatives-section {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-top: 10px;
        }

        #create-question #alternatives-section h3 {
            font-size: 0.9rem;
            margin: 0 0 12px 0;
            color: #1e293b;
        }

        /* Alternativas como Textarea (Compactas) */
        #create-question #alternatives-inputs textarea {
            height: 50px !important;
            font-size: 0.85rem !important;
        }

        /* Bot√£o Profissional Slim */
        #create-question .btn-primary {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            width: fit-content;
        }

        #create-question .btn-primary:hover {
            background: #1d4ed8;
        }

        /* Responsividade para manter tudo na tela */
        @media (max-width: 1024px) {
            #create-question .dashboard-grid {
                grid-template-columns: 1fr !important;
            }
            #create-question #alternatives-inputs {
                grid-template-columns: 1fr 1fr !important;
            }
        }
    </style>

    <h2><i class="fas fa-plus-circle"></i> Cadastrar Nova Quest√£o</h2>
    <div class="alert-info">
        <i class="fas fa-info-circle"></i> O upload de todas as imagens agora utiliza o ImgAtecsevenServer.
    </div>

    <form id="form-create-question">
        <div class="dashboard-grid" style="grid-template-columns: repeat(2, 1fr);">
            <div>
                <label for="modalidade">Modalidade de Ensino:</label>
                <select id="modalidade" required>
                    <option value="Ensino Fundamental I">Ensino Fundamental I</option>
                    <option value="Ensino Fundamental II">Ensino Fundamental II</option>
                    <option value="Ensino M√©dio">Ensino M√©dio</option>
                </select>

                <label for="componente">Componente Curricular:</label>
                <input type="text" id="componente" placeholder="Ex: Matem√°tica, Portugu√™s" required>

                <label for="habilidade">Habilidade BNCC (D-XX):</label>
                <input type="text" id="habilidade" placeholder="Ex: D 33">

                <label for="tipo">Tipo de Quest√£o:</label>
                <select id="tipo" onchange="toggleAlternatives(this.value)" required>
                    <option value="M√∫ltipla Escolha">M√∫ltipla Escolha</option>
                    <option value="Discursiva">Discursiva</option>
                </select>

                <div id="linhas-discursiva-group" style="display: none;">
                    <label for="linhas-discursiva">Linhas para Resposta:</label>
                    <input type="number" id="linhas-discursiva" min="1" max="20" value="4">
                </div>
            </div>

            <div>
                <label for="enunciado">Enunciado da Quest√£o (Texto):</label>
                <textarea id="enunciado" required placeholder="Digite o corpo da quest√£o..."></textarea>

                <label for="enunciado-imagem">Imagem/M√≠dia (Upload):</label>
                <input type="file" id="enunciado-imagem" accept="image/*" style="border: 2px dashed #cbd5e1 !important; padding: 10px !important;">
            </div>
        </div>

        <div id="alternatives-section">
            <h3>Alternativas (M√∫ltipla Escolha)</h3>
            <div id="alternatives-inputs" class="dashboard-grid" style="grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <div>
                    <label>A</label>
                    <textarea placeholder="Texto da A"></textarea>
                </div>
                <div>
                    <label>B</label>
                    <textarea placeholder="Texto da B"></textarea>
                </div>
                <div>
                    <label>C</label>
                    <textarea placeholder="Texto da C"></textarea>
                </div>
            </div>

            <div style="max-width: 200px;">
                <label for="resposta-correta">Resposta Correta:</label>
                <select id="resposta-correta" required style="border-color: #2563eb !important;">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                </select>
            </div>
        </div>

        <button type="button" class="btn-primary" onclick="handleCreateQuestion()">
            <i class="fas fa-save"></i> Salvar Quest√£o
        </button>
        <div id="question-creation-message"></div>
    </form>
</section>
<!--/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner       ATECSEVEN TECNOLOGIA
 * @cnpj        63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */-->
            <section id="bank" class="page-section">
    <h2><i class="fas fa-database"></i> Banco de Quest√µes</h2>
    
    <div class="filter-container" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
        <input type="text" id="filter-bank-text" 
               placeholder="Busque por qualquer termo (ex: 'fra√ß√µes ensino m√©dio')..." 
               oninput="filterQuestions()" 
               style="flex: 1; min-width: 250px; padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1;">
        
        <select id="filter-bank-modalidade" onchange="filterQuestions()" 
                style="padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; background: white;">
            <option value="">Todas as Modalidades</option>
            <option value="Ensino Fundamental I">Ensino Fundamental I</option>
            <option value="Ensino Fundamental II">Ensino Fundamental II</option>
            <option value="Ensino M√©dio">Ensino M√©dio</option>
        </select>
    </div>
    
    <div class="bank-controls" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
        <button type="button" class="btn-success" onclick="selectAllQuestions(true)">
            <i class="fas fa-check-double"></i> Selecionar Todas
        </button>
        <button type="button" class="btn-secondary" onclick="selectAllQuestions(false)">
            <i class="fas fa-times-circle"></i> Desmarcar Todas
        </button>
        <button type="button" class="btn-success" onclick="sendSelectedToExam()">
            <i class="fas fa-paper-plane"></i> Enviar Selecionadas para a Prova
        </button>
    </div>

    <ul id="questions-bank-list" class="exam-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; list-style: none; padding: 0;">
        <li style="grid-column: 1/-1; text-align: center; padding: 50px;">
            <i class="fas fa-sync fa-spin fa-2x"></i><br>Carregando Banco de Dados...
        </li>
    </ul>
</section>
            
            <section id="create-exam" class="page-section">
            <div id="header-cloud-manager" 
            style="background: #f0f7ff; 
            border: 2px solid #f0f7ff; 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 25px; 
            font-family: sans-serif;">

            <h4 style="margin: 0 0 15px 0; color: #1e293b; display: flex; align-items: center; gap: 10px; font-size: 16px; font-weight: 600;">            <i class="fas fa-cloud-upload-alt"></i> Meus Cabe√ßalhos Salvos
            </h4>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <select id="select-header-model" style="flex: 1; min-width: 200px; padding: 10px; border-radius: 6px; border: 1px solid #3b82f6; background: white; font-weight: 500;">
                <option value="">Lista de Cabe√ßalhos Salvos</option>
            </select>
            <button type="button" onclick="applyServerHeader()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                <i class="fas fa-check"></i> Aplicar Cabe√ßalho
            </button>
            <button type="button" onclick="saveServerHeader()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                <i class="fas fa-save"></i> Salvar Novo Cabe√ßalho
            </button>
            <button type="button" onclick="deleteServerHeader()" style="background: #ef4444; color: white; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer;">
                <i class="fas fa-trash"></i>
            </button>
            </div>
            <div id="status-imgbb" style="font-size: 12px; margin-top: 8px; font-weight: 500; color: #475569;"></div>
            </div>

   <div style="font-family: 'Segoe UI', system-ui, sans-serif; color: #334155; width: 95%; max-width: 1400px; margin: 20px auto; padding: 25px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
    
    <style>
        .exam-header { display: flex; align-items: center; gap: 12px; margin-bottom: 25px; color: #1e293b; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; }
        .exam-header h2 { margin: 0; font-size: 1.4rem; }

        .exam-grid-3 { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            margin-bottom: 20px;
        }

        .field-group { display: flex; flex-direction: column; margin-bottom: 5px; }
        .field-group.span-2 { grid-column: span 2; }

        .exam-form label { font-size: 0.8rem; font-weight: 700; color: #475569; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.025em; }
        
        .exam-form input, .exam-form select, .exam-form textarea {
            padding: 10px; border: 1px solid #cbd5e1; border-radius: 5px; font-size: 0.9rem; color: #1e293b;
            background-color: #f8fafc; transition: all 0.2s;
        }

        .exam-form input:focus, .exam-form select:focus { outline: none; border-color: #3b82f6; background-color: #fff; box-shadow: 0 0 0 1px #3b82f6; }
        .exam-form input:disabled { background-color: #f1f5f9; cursor: not-allowed; opacity: 0.7; }

        .logo-input-wrapper {
            display: flex; align-items: center; gap: 10px; padding: 6px; border: 1px solid #cbd5e1; border-radius: 5px; background: #fff;
        }

        .questions-container {
            margin-top: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px;
        }
        #exam-questions-list { 
            max-height: 400px; overflow-y: auto; background: #fff; border: 1px solid #cbd5e1; border-radius: 4px; padding: 10px; margin-top: 10px; 
        }

        .btn-base { cursor: pointer; border-radius: 5px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; border: none; }
        .btn-shuffle { background: #64748b; color: white; padding: 8px 12px; font-size: 0.8rem; }
        .btn-generate { background: #2563eb; color: white; padding: 15px; width: 100%; justify-content: center; font-size: 1rem; margin-top: 20px; }
        .btn-generate:hover { background: #1d4ed8; }

        .info-box { background: #eff6ff; border-left: 4px solid #3b82f6; color: #1e40af; padding: 12px; font-size: 0.85rem; margin-bottom: 15px; border-radius: 0 4px 4px 0; }
        
        h3.section-title { font-size: 0.95rem; color: #3b82f6; margin: 20px 0 15px 0; display: flex; align-items: center; gap: 8px; }
        h3.section-title::after { content: ""; flex: 1; height: 1px; background: #e2e8f0; }
    </style>

    <div class="exam-header">
        <i class="fas fa-file-export" style="font-size: 1.5rem; color: #3b82f6;"></i>
        <h2>Gerar Nova Prova</h2>
    </div>

    <form id="form-create-exam" class="exam-form" onsubmit="event.preventDefault();">
        
        <h3 class="section-title">1. Informa√ß√µes Institucionais</h3>
        <div class="exam-grid-3">
            <div class="field-group span-2">
                <label for="cabecalho-escola">Nome da Institui√ß√£o/Escola</label>
                <input type="text" id="cabecalho-escola" placeholder="Ex: Instituto Federal de Educa√ß√£o" required>
            </div>
            
            <div class="field-group">
                <label for="cabecalho-logo-file">Logo da Escola</label>
                <div class="logo-input-wrapper">
                    <div id="mini-preview-logo" style="width: 30px; height: 30px; border: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; border-radius: 4px; background: #f8fafc;">
                        <i class="fas fa-image" style="color: #cbd5e1;"></i>
                    </div>
                    <input type="file" id="cabecalho-logo-file" accept="image/*" style="font-size: 0.7rem; border: none; width: 100%; background: transparent;">
                </div>
            </div>
        </div>

        <h3 class="section-title">2. Dados da Disciplina e Docente</h3>
        <div class="exam-grid-3">
            <div class="field-group">
                <label for="cabecalho-disciplina-select">Disciplina</label>
                <input type="text" id="cabecalho-disciplina-select" list="lista-sugestoes-disciplina" required onchange="filterQuestionsForExam()" placeholder="Digite ou selecione...">
                <datalist id="lista-sugestoes-disciplina">
                    <option value="Matem√°tica"><option value="Portugu√™s"><option value="Hist√≥ria"><option value="Geografia"><option value="Ci√™ncias">
                </datalist>
            </div>

            <div class="field-group">
                <label for="cabecalho-professor">Professor</label>
                <input type="text" id="cabecalho-professor" required disabled>
            </div>

            <div class="field-group">
                <label for="cabecalho-data-prova">Data da Prova</label>
                <input type="date" id="cabecalho-data-prova" required>
            </div>
        </div>

        <h3 class="section-title">3. Turma e Formata√ß√£o</h3>
        <div class="exam-grid-3">
            <div class="field-group">
                <label for="cabecalho-turma">Turma</label>
                <input type="text" id="cabecalho-turma" required placeholder="Ex: 3¬∫ Ano B">
            </div>

            <div class="field-group">
                <label for="cabecalho-turno">Turno</label>
                <select id="cabecalho-turno">
                    <option value="Matutino">Matutino</option>
                    <option value="Vespertino">Vespertino</option>
                    <option value="Noturno">Noturno</option>
                </select>
            </div>

            <div class="field-group">
                <label for="cabecalho-periodo">Per√≠odo/Etapa</label>
                <select id="cabecalho-periodo" required>
                    <option value="1¬∫ PER√çODO">1¬∫ PER√çODO</option>
                    <option value="2¬∫ PER√çODO">2¬∫ PER√çODO</option>
                    <option value="3¬∫ PER√çODO">3¬∫ PER√çODO</option>
                    <option value="4¬∫ PER√çODO">4¬∫ PER√çODO</option>
                </select>
            </div>

            <div class="field-group">
                <label for="layout">Layout das Colunas</label>
                <select id="layout">
                    <option value="1">1 Coluna (Simples)</option>
                    <option value="2" selected>2 Colunas (Padr√£o Oficial)</option>
                </select>
            </div>

            <div class="field-group span-2">
                <label for="instrucoes">Instru√ß√µes Gerais</label>
                <textarea id="instrucoes" rows="1">Leia atentamente todas as quest√µes antes de responder. Use caneta azul ou preta e evite rasuras.</textarea>
            </div>
        </div>

        <div class="questions-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label style="margin: 0; font-size: 0.9rem; color: #1e293b;">Quest√µes Selecionadas</label>
                <button type="button" class="btn-base btn-shuffle" onclick="shuffleSelectedQuestions()">
                    <i class="fas fa-random"></i> Embaralhar Quest√µes
                </button>
            </div>

            <div id="selected-questions-from-bank" class="info-box" style="display: none;">
                <i class="fas fa-info-circle"></i> Quest√µes carregadas do banco. Revise a ordem antes de gerar o arquivo.
            </div>

            <div id="exam-questions-list">
                <p style="text-align: center; color: #94a3b8; font-style: italic; padding: 20px;">
                    Selecione uma disciplina ou utilize o banco para listar as quest√µes aqui.
                </p>
            </div>
        </div>

        <button type="button" class="btn-base btn-generate" onclick="handleCreateExam().then(() => { setTimeout(() => { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }, 500); })">
    <i class="fas fa-bolt"></i> GERAR PROVA
</button>

        <div id="exam-creation-message" style="margin-top: 15px;"></div>
    </form>
</div>

<script>
async function handleCreateExam() {
    const messageEl = document.getElementById('exam-creation-message');
    messageEl.innerHTML = `<div class="alert-info"><i class="fas fa-sync fa-spin"></i> Processando upload e gera√ß√£o...</div>`;
    
    try {
        const finalSelectedIds = Array.from(document.querySelectorAll('#exam-questions-list input[name="selected_questions"]:checked')).map(cb => cb.value);
        if (finalSelectedIds.length === 0) throw new Error("Selecione pelo menos uma quest√£o.");

        const logoFile = document.getElementById('cabecalho-logo-file').files[0];
        let logoUrl = logoFile ? await uploadFileToImgBB(logoFile) : "";
        
        // Coletando a data bruta do input (AAAA-MM-DD)
        const dataInput = document.getElementById('cabecalho-data-prova')?.value || '';

        const dadosProva = {
            cabecalho: {
                escola: document.getElementById('cabecalho-escola')?.value || '',
                logo: logoUrl,
                turma: document.getElementById('cabecalho-turma')?.value || '',
                turno: document.getElementById('cabecalho-turno')?.value || '',
                disciplina: document.getElementById('cabecalho-disciplina-select')?.value || '',
                professor: document.getElementById('cabecalho-professor')?.value || '',
                periodo: document.getElementById('cabecalho-periodo')?.value || '',
                data_prova: dataInput // Salva como 2026-02-15
            },
            instrucoes_gerais: document.getElementById('instrucoes').value,
            layout_colunas: document.getElementById('layout').value,
            questoes_detalhes: finalSelectedIds.map(id => allQuestions[id]).filter(q => q),
            data_geracao: new Date().toISOString(),
            criado_por_uid: CURRENT_USER_ID
        };

        const novaProvaRef = database.ref('provas').push();
        await novaProvaRef.set(dadosProva);

        messageEl.innerHTML = `<div class="alert-success">Sucesso!</div>`;
        document.getElementById('form-create-exam').reset();
        await updateExamListView();
        showPage('my-exams');
        selectExam(novaProvaRef.key);

    } catch (error) {
        messageEl.innerHTML = `<div class="alert-error">Erro: ${error.message}</div>`;
    }
}
</script>

    <script>
        var IMGBB_API_KEY = "95bb16ee776d7e20f26857cec98bd372";
        var currentImgUrl = "";

        document.getElementById('cabecalho-logo-file').onchange = function(e) {
    var file = e.target.files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function(event) {
        // Aqui est√° o c√≥digo Base64 puro
        var base64 = event.target.result;
        
        // Guardamos o Base64 na vari√°vel que ser√° salva no banco
        currentImgUrl = base64; 
        window.logoBase64Final = base64;

        // Preview imediato
        document.getElementById('mini-preview-logo').innerHTML = '<img src="'+base64+'" style="width:100%;height:100%;object-fit:contain;">';
        document.getElementById('status-imgbb').innerHTML = '<span style="color:#10b981">‚úì Imagem carregada (Base64)</span>';
    };
    reader.readAsDataURL(file);
};

        function loadServerHeaders() {
            var profNome = document.getElementById('cabecalho-professor').value;
            if (!profNome) return;
            var path = 'modelos_v3/' + profNome.replace(/[.#$\[\]]/g, "_");
            database.ref(path).on('value', function(snap) {
                var sel = document.getElementById('select-header-model');
                sel.innerHTML = '<option value="">Listagem de Cabel√ßalhos</option>';
                snap.forEach(function(c) {
                    var d = c.val();
                    var o = document.createElement('option');
                    o.value = c.key; o.dataset.m = JSON.stringify(d);
                    o.textContent = d.escola + " (" + (d.turma || 'Geral') + ")";
                    sel.appendChild(o);
                });
            });
        }

        var profWatcher = setInterval(function() {
            var p = document.getElementById('cabecalho-professor').value;
            if(p && p !== "") { loadServerHeaders(); clearInterval(profWatcher); }
        }, 1000);

        function saveServerHeader() {
            var esc = document.getElementById('cabecalho-escola').value;
            var prof = document.getElementById('cabecalho-professor').value;
            if(!prof || !esc) return alert("Preencha os campos!");
            var m = {
                escola: esc, disciplina: document.getElementById('cabecalho-disciplina-select').value,
                turma: document.getElementById('cabecalho-turma').value, turno: document.getElementById('cabecalho-turno').value,
                periodo: document.getElementById('cabecalho-periodo').value, instrucoes: document.getElementById('instrucoes').value,
                logo: currentImgUrl
            };
            database.ref('modelos_v3/' + prof.replace(/[.#$\[\]]/g, "_")).push(m, function(err) { if(!err) alert("Salvo!"); });
        }

       function applyServerHeader() {
    var sel = document.getElementById('select-header-model');
    if(!sel.value) return;
    
    // Pega os dados do modelo salvo
    var m = JSON.parse(sel.options[sel.selectedIndex].dataset.m);
    
    // Preenche os campos de texto
    document.getElementById('cabecalho-escola').value = m.escola || "";
    document.getElementById('cabecalho-turma').value = m.turma || "";
    document.getElementById('cabecalho-turno').value = m.turno || "";
    document.getElementById('cabecalho-periodo').value = m.periodo || "";
    document.getElementById('instrucoes').value = m.instrucoes || "";
    document.getElementById('cabecalho-disciplina-select').value = m.disciplina || "";
    
    // Recupera a logo (que agora j√° deve ser o Base64 vindo do banco)
    currentImgUrl = m.logo || "";
    
    if(currentImgUrl) {
        // Se come√ßar com "data:image", √© um Base64 real e vai funcionar direto
        window.logoBase64Final = currentImgUrl;
        window.cabecalhoLogoUrl = currentImgUrl;

        document.getElementById('mini-preview-logo').innerHTML = '<img src="'+currentImgUrl+'" style="width:100%;height:100%;object-fit:contain;">';
        document.getElementById('status-imgbb').innerHTML = '<span style="color:#10b981">‚úì Logo sincronizada!</span>';
    } else {
        document.getElementById('mini-preview-logo').innerHTML = "";
        document.getElementById('status-imgbb').innerHTML = "Sem logo";
    }

    if(window.filterQuestionsForExam) filterQuestionsForExam();
}
        function deleteServerHeader() {
            var sel = document.getElementById('select-header-model');
            if(!sel.value) return;
            var prof = document.getElementById('cabecalho-professor').value;
            if(confirm("Excluir?")) database.ref('modelos_v3/' + prof.replace(/[.#$\[\]]/g, "_") + '/' + sel.value).remove();
        }
    </script>
</section>
<!--PARAACHARAPIDOXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX-->
            <section id="my-exams" class="page-section">
    <style>
        #my-exams { 
            padding: 20px; 
            background-color: #f1f5f9; 
            font-family: 'Inter', -apple-system, sans-serif; 
        }

        #my-exams h2 { 
            color: #0f172a; 
            font-size: 1.25rem; 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        /* Barra de Busca */
        .search-bar { position: relative; max-width: 500px; margin-bottom: 25px; }
        .search-bar i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #64748b; }
        #filter-exams-text { 
            width: 100%; padding: 12px 12px 12px 40px; 
            border: 1px solid #cbd5e1; border-radius: 8px; 
            font-size: 0.9rem; outline: none; transition: 0.2s;
        }
        #filter-exams-text:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* Grid de Blocos Responsivos */
        .exam-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        /* O Card (Bloquinho) */
        .exam-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .exam-card:hover { 
            border-color: #3b82f6; 
            transform: translateY(-3px); 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
        }

        .exam-card.active { 
            border: 2px solid #3b82f6; 
            background-color: #f0f7ff; 
        }

        .exam-card .school-label { 
            font-size: 0.65rem; 
            font-weight: 800; 
            color: #3b82f6; 
            text-transform: uppercase; 
        }

        .exam-card h4 { 
            margin: 0; 
            font-size: 1rem; 
            color: #1e293b; 
            line-height: 1.2; 
            min-height: 2.4em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .info-grid-card { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 6px; 
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f1f5f9;
        }

        .info-item-card { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 0.75rem; 
            color: #64748b; 
        }

        .info-item-card i { color: #94a3b8; width: 14px; }

        /* Painel de A√ß√µes Original Preservado */
        #exam-details-view {
            background: white; 
            border-radius: 12px; 
            padding: 20px;
            border: 1px solid #cbd5e1; 
            margin-top: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .action-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 15px; 
        }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        .btn-mini { 
            padding: 8px 15px; 
            font-size: 0.8rem; 
            font-weight: 600; 
            border-radius: 6px; 
            border: 1px solid #e2e8f0; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            background: white;
            transition: 0.2s;
        }

        .btn-mini.primary { background: #3b82f6; color: white; border: none; }
        .btn-mini.danger { color: #ef4444; background: #fef2f2; border: none; }
        .btn-mini:hover { opacity: 0.9; transform: scale(1.02); }

        @media (max-width: 480px) {
            .exam-grid { grid-template-columns: 1fr; }
            .action-bar { flex-direction: column; align-items: flex-start; }
        }
    </style>

    <h2><i class="fas fa-file-signature"></i> Minhas Provas Geradas</h2>
    
    <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" id="filter-exams-text" placeholder="Pesquisar por disciplina, turma ou professor..." onkeyup="filterExams()">
    </div>

    <div id="my-exams-list" class="exam-grid">
        <p style="color: #64748b;">Carregando suas provas...</p>
    </div>
    
    <div id="exam-details-view" style="display: none;">
        <div class="action-bar">
            <div>
                <small style="color: #64748b; font-weight: 600;">PROVA SELECIONADA:</small>
                <div id="selected-exam-name" style="font-size: 1.1rem; font-weight: 700; color: #0f172a;"></div>
            </div>
            <div class="btn-group">
<button class="btn-mini primary" onclick="reparoMestreViaModelo(); visualizarProvaDetalhe();">
    <i class="fas fa-eye"></i> Visualizar</button>                <button class="btn-mini" onclick="exportarProva('pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
<button class="btn-mini" onclick="reparoMestreViaModelo(); baixarGabarito()">
    <i class="fas fa-key"></i> Gabarito
</button>                <button class="btn-mini" onclick="openEditExamModal()"><i class="fas fa-edit"></i> Editar</button>
                <button class="btn-mini danger" onclick="deleteExam()"><i class="fas fa-trash"></i> Excluir</button>
            </div>
        </div>
        
        <div id="exam-preview" style="display: none; margin-top: 20px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
            <div id="exam-content-print" style="background: white; padding: 30px; min-height: 200px;"></div>
        </div>
    </div>

    <script>
        async function reparoMestreViaModelo() {
    if (!selectedExamId) return;

    try {
        const infoDisplay = document.getElementById('user-info-display');
        if (!infoDisplay) return;

        // LIMPEZA DO NOME: Remove o prefixo " | Seja Bem-Vindo "
        // O replace usa uma express√£o regular para tirar tudo que n√£o for o nome
        const nomeUsuarioLogado = infoDisplay.textContent
            .replace(/.*Bem-Vindo\s+/, "") 
            .replace(/["']/g, "") // Remove aspas se houver
            .trim();

        console.log("--- REPARO INICIADO PARA: " + nomeUsuarioLogado + " ---");

        // 1. Busca os dados da PROVA
        const snapProva = await database.ref('provas/' + selectedExamId).once('value');
        const dadosProva = snapProva.val();
        if (!dadosProva || !dadosProva.cabecalho) return;

        const escolaDaProva = dadosProva.cabecalho.escola;

        // 2. Busca no n√≥ MODELOS_V3 usando o nome limpo
        const snapModelos = await database.ref(`modelos_v3/${nomeUsuarioLogado}`).once('value');
        const modelosUsuario = snapModelos.val();

        let logoRecuperada = "";

        if (modelosUsuario) {
            // Percorre os modelos para achar a escola correspondente
            Object.values(modelosUsuario).forEach(modelo => {
                if (modelo.escola === escolaDaProva && modelo.logo) {
                    logoRecuperada = modelo.logo;
                }
            });
        }

        if (!logoRecuperada) {
            console.log("Nenhuma logo encontrada para esta escola nos modelos de " + nomeUsuarioLogado);
            return;
        }

        // 3. ATUALIZA√á√ÉO SILENCIOSA NO BANCO E NA TELA
        await database.ref(`provas/${selectedExamId}/cabecalho`).update({ logo: logoRecuperada });

        // Atualiza as vari√°veis globais do sistema para a visualiza√ß√£o imediata
        if (typeof allExams !== 'undefined' && allExams[selectedExamId]) {
            allExams[selectedExamId].cabecalho.logo = logoRecuperada;
        }
        window.logoBase64Final = logoRecuperada;

        console.log("‚úÖ Logo reparada com sucesso!");

    } catch (e) {
        console.error("Erro no reparo mestre:", e);
    }
}
        /**
         * FUN√á√ÉO PRINCIPAL: Renderiza os blocos com trava de seguran√ßa
         * @param {Object} examsData - O objeto 'provas' vindo do Firebase
         */
        function renderMyExams(examsData) {
            const container = document.getElementById('my-exams-list');
            container.innerHTML = "";
            
            // PEGA O UID DO USU√ÅRIO ATUAL (Ajuste para sua vari√°vel global de login)
            const currentUserId = (typeof userLogado !== 'undefined' && userLogado) ? userLogado.uid : null;

            if (!examsData) {
                container.innerHTML = "<p>Nenhuma prova dispon√≠vel.</p>";
                return;
            }

            let count = 0;
            Object.keys(examsData).forEach(id => {
                const prova = examsData[id];

                // --- TRAVA DE SEGURAN√áA ABSOLUTA ---
                // Se a prova n√£o foi criada por este UID, o sistema ignora e n√£o renderiza nada
                if (prova.criado_por_uid !== currentUserId) {
                    return; 
                }

                count++;
                const info = prova.cabecalho || {};
                const card = document.createElement('div');
                card.className = 'exam-card';
                card.onclick = () => selectExam(card, id, info.disciplina);

                card.innerHTML = `
                    <div class="school-label">${info.escola || 'INSTITUTO FEDERAL'}</div>
                    <h4>${info.disciplina || 'Sem T√≠tulo'}</h4>
                    <div class="info-grid-card">
                        <div class="info-item-card" title="Turma"><i class="fas fa-users"></i> ${info.turma || '-'}</div>
                        <div class="info-item-card" title="Turno"><i class="fas fa-sun"></i> ${info.turno || '-'}</div>
                        <div class="info-item-card" title="Data"><i class="far fa-calendar-alt"></i> ${info.data_prova || '-'}</div>
                        <div class="info-item-card" title="Professor"><i class="fas fa-chalkboard-teacher"></i> ${info.professor || '-'}</div>
                    </div>
                `;
                container.appendChild(card);
            });

            if (count === 0) {
                container.innerHTML = "<p>Voc√™ ainda n√£o gerou nenhuma prova.</p>";
            }
        }

        // Seleciona o card e ativa as fun√ß√µes originais
        function selectExam(element, id, nome) {
            document.querySelectorAll('.exam-card').forEach(c => c.classList.remove('active'));
            element.classList.add('active');
            
            // Mant√©m a compatibilidade com suas fun√ß√µes originais de PDF/Delete
            window.selectedExamId = id; 
            
            document.getElementById('selected-exam-name').innerText = nome;
            document.getElementById('exam-details-view').style.display = 'block';
            
            // Se o preview estiver aberto de uma prova anterior, fecha ele
            document.getElementById('exam-preview').style.display = 'none';
        }

        // Fun√ß√£o de Filtro (Busca)
        function filterExams() {
            const query = document.getElementById('filter-exams-text').value.toLowerCase();
            const cards = document.querySelectorAll('.exam-card');
            cards.forEach(card => {
                const content = card.innerText.toLowerCase();
                card.style.display = content.includes(query) ? "flex" : "none";
            });
        }

        /* COMO CONECTAR:
           No seu c√≥digo onde voc√™ recebe os dados do Firebase (ex: firebase.database().ref('provas')),
           basta chamar: renderMyExams(snapshot.val());
        */
    </script>
            </section>
            <!--/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner       ATECSEVEN TECNOLOGIA
 * @cnpj        63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */-->
<section id="admin" class="page-section admin-optimized">
    <style>
        .admin-optimized { max-width: 1400px !important; margin: 20px auto; padding: 25px !important; }
        .admin-top-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
        .admin-card-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; }
        
        .admin-card-box h3 { 
            font-size: 0.9rem; color: #3f51b5; display: flex; 
            align-items: center; justify-content: space-between; 
            border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; 
            text-transform: uppercase; margin-bottom: 20px; 
        }

        .btn-refresh { 
            background: none; border: none; color: #3f51b5; 
            cursor: pointer; font-size: 1.1rem; transition: 0.3s; 
            padding: 5px; display: flex; align-items: center;
        }
        .btn-refresh:hover { color: #10b981; transform: scale(1.1); }

        .internal-form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .full-span { grid-column: span 2; }
        .internal-form input, .internal-form select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1; box-sizing: border-box; }

        .user-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 10px; }
        .user-table th, .user-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align: left; font-size: 0.85rem; }
        .col-nome { width: 25%; } .col-email { width: 20%; } .col-nivel { width: 10%; } .col-status { width: 10%; } .col-acoes { width: 35%; text-align: right !important; }

        .btn-action-group { display: flex; gap: 5px; justify-content: flex-end; flex-wrap: wrap; }
        .btn-sm-text { padding: 5px 10px; font-size: 0.75rem; border-radius: 4px; border: none; cursor: pointer; display: flex; align-items: center; gap: 4px; font-weight: 600; color: white; transition: 0.3s; }
        .btn-edit { background-color: #6366f1; }
        .btn-approve { background-color: #10b981; }
        .btn-suspend { background-color: #f59e0b; }
        .btn-delete { background-color: #ef4444; }

        .status-badge { font-weight: bold; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }
        .status-Aprovado { color: #10b981; }
        .status-Pendente { color: #f59e0b; }
        .status-Suspenso { color: #ef4444; }

        .pending-item { background: white; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    </style>

    <h2><i class="fas fa-user-shield"></i> Painel Administrativo</h2>
    
    <div class="admin-top-grid">
        <div class="admin-card-box">
            <h3><span><i class="fas fa-user-edit"></i> Cadastro / Edi√ß√£o</span></h3>
            <div class="internal-form" id="admin-form">
                <input type="hidden" id="edit-user-id">
                <input type="text" id="new-user-name" class="full-span" placeholder="Nome Completo">
                <input type="text" id="new-user-school" class="full-span" placeholder="Escola">
                <input type="email" id="new-user-email" placeholder="E-mail">
                <input type="text" id="new-user-password" placeholder="Senha"> 
                <select id="new-user-role" class="full-span">
                    <option value="ADM">Administrador</option>
                    <option value="Professor">Professor</option>
                </select>
                <button type="button" class="btn-primary full-span" id="btn-save-user">Salvar Usu√°rio</button>
                <button type="button" class="btn-secondary full-span" id="btn-cancel-edit" style="display:none;">Cancelar Edi√ß√£o</button>
            </div>
        </div>

        <div class="admin-card-box">
            <h3>
                <span><i class="fas fa-user-clock"></i> Pendentes de Aprova√ß√£o</span>
                <button class="btn-refresh" onclick="window.refreshData()"><i class="fas fa-sync-alt"></i></button>
            </h3>
            <div id="pending-users-list">
                <p style="text-align:center; color:#94a3b8;">Buscando dados...</p>
            </div>
        </div>
    </div>

    <div class="active-users-section">
        <div class="management-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin:0;"><i class="fas fa-users"></i> Gerenciar Todos os Usu√°rios</h3>
            <div class="search-container" style="position: relative; width: 300px;">
                <input type="text" id="admin-search" placeholder="Buscar..." style="width:100%; padding:8px 10px; border-radius:6px; border:1px solid #ddd;" onkeyup="filterTable()">
            </div>
        </div>
        <table class="user-table">
            <thead>
                <tr>
                    <th class="col-nome">Nome / Escola</th>
                    <th class="col-email">E-mail</th>
                    <th class="col-nivel">N√≠vel</th>
                    <th class="col-status">Status</th>
                    <th class="col-acoes">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="users-table-body"></tbody>
        </table>
    </div>
</section>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove, push, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
    apiKey: "AIzaSyCSeSmkMM_4-NlLv8Js_ODwA4H372yq48k",
    authDomain: "rnc-sgt.firebaseapp.com",
    databaseURL: "https://rnc-sgt-default-rtdb.firebaseio.com",
    projectId: "rnc-sgt",
    storageBucket: "rnc-sgt.firebasestorage.app",
    messagingSenderId: "500336948308",
    appId: "1:500336948308:web:a6448b9141974f542ce9c1",
    measurementId: "G-LB9EQPJRQ1"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function renderizarPainel(snapshot) {
        const tableBody = document.getElementById('users-table-body');
        const pendingList = document.getElementById('pending-users-list');
        
        tableBody.innerHTML = '';
        pendingList.innerHTML = '';
        let hasPending = false;

        snapshot.forEach((child) => {
            const user = child.val();
            const id = child.key;
            const status = user.status || "Pendente";
            const nivel = user.cargo || user.role || "Professor";

            if (status === "Pendente") {
                hasPending = true;
                pendingList.innerHTML += `
                    <div class="pending-item">
                        <div><strong>${user.nome}</strong><br><small>${user.email}</small></div>
                        <button class="btn-sm-text btn-approve" onclick="window.updateStatus('${id}', 'Aprovado')">APROVAR</button>
                    </div>`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${user.nome}</strong><br><small>${user.escola || ''}</small></td>
                <td>${user.email}</td>
                <td>${nivel}</td>
                <td><span class="status-badge status-${status}">${status}</span></td>
                <td class="col-acoes">
                    <div class="btn-action-group">
                        ${status !== 'Aprovado' ? `<button class="btn-sm-text btn-approve" onclick="window.updateStatus('${id}', 'Aprovado')">APROVAR</button>` : ''}
                        <button class="btn-sm-text btn-edit" onclick="window.editUser('${id}')">EDITAR</button>
                        <button class="btn-sm-text btn-suspend" onclick="window.updateStatus('${id}', 'Suspenso')">SUSPENDER</button>
                        <button class="btn-sm-text btn-delete" onclick="window.deleteUser('${id}')">EXCLUIR</button>
                    </div>
                </td>`;
            tableBody.appendChild(tr);
        });

        if (!hasPending) pendingList.innerHTML = '<p style="text-align:center; color:#94a3b8;">Nenhum pendente.</p>';
    }

    window.refreshData = () => {
        const icon = document.querySelector('.btn-refresh i');
        icon.classList.add('fa-spin');
        get(ref(db, 'usuarios')).then((snapshot) => {
            renderizarPainel(snapshot);
            setTimeout(() => icon.classList.remove('fa-spin'), 600);
        });
    };

    onValue(ref(db, 'usuarios'), (snapshot) => renderizarPainel(snapshot));

    window.updateStatus = (id, newStatus) => update(ref(db, `usuarios/${id}`), { status: newStatus });
    
    window.deleteUser = (id) => confirm("Excluir?") && remove(ref(db, `usuarios/${id}`));

    window.editUser = (id) => {
        get(ref(db, `usuarios/${id}`)).then((snap) => {
            const user = snap.val();
            document.getElementById('edit-user-id').value = id;
            document.getElementById('new-user-name').value = user.nome;
            document.getElementById('new-user-school').value = user.escola || '';
            document.getElementById('new-user-email').value = user.email;
            document.getElementById('new-user-password').value = user.password_hash || '';
            document.getElementById('new-user-role').value = user.role || user.cargo || 'Professor';
            document.getElementById('btn-save-user').innerText = "Atualizar Cadastro";
            document.getElementById('btn-cancel-edit').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    };

    document.getElementById('btn-save-user').onclick = async () => {
        const id = document.getElementById('edit-user-id').value;
        const data = {
            nome: document.getElementById('new-user-name').value,
            escola: document.getElementById('new-user-school').value,
            email: document.getElementById('new-user-email').value,
            password_hash: document.getElementById('new-user-password').value,
            role: document.getElementById('new-user-role').value,
            status: "Aprovado"
        };
        if(id) await update(ref(db, `usuarios/${id}`), data);
        else await push(ref(db, 'usuarios'), { ...data, data_solicitacao: new Date().toISOString() });
        resetForm();
    };

    function resetForm() {
        document.getElementById('edit-user-id').value = '';
        document.querySelectorAll('#admin-form input').forEach(i => i.value = '');
        document.getElementById('btn-save-user').innerText = "Salvar Usu√°rio";
        document.getElementById('btn-cancel-edit').style.display = 'none';
    }

    window.filterTable = () => {
        const term = document.getElementById('admin-search').value.toLowerCase();
        document.querySelectorAll('#users-table-body tr').forEach(r => {
            r.style.display = r.innerText.toLowerCase().includes(term) ? '' : 'none';
        });
    };
    
    document.getElementById('btn-cancel-edit').onclick = resetForm;
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDFQCMsX04fwh7MVyEpvXnXD0U4TD5Or5w",
        authDomain: "ja-barbearia.firebaseapp.com",
        databaseURL: "https://ja-barbearia-default-rtdb.firebaseio.com",
        projectId: "ja-barbearia",
        storageBucket: "ja-barbearia.firebasestorage.app",
        messagingSenderId: "213237027963",
        appId: "1:213237027963:web:7d585b158ee06d3ab7fede"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Renderiza√ß√£o Real-time
    onValue(ref(db, 'usuarios'), (snapshot) => {
        const tableBody = document.getElementById('users-table-body');
        const pendingList = document.getElementById('pending-users-list');
        tableBody.innerHTML = '';
        pendingList.innerHTML = '';
        let hasPending = false;

        snapshot.forEach((child) => {
            const user = child.val();
            const id = child.key;
            const statusStr = String(user.status);

            // Se√ß√£o de Pendentes
            if (statusStr.trim() === "Pendente") {
                hasPending = true;
                pendingList.innerHTML += `
                    <div class="pending-item">
                        <div><strong>${user.nome}</strong><br><small>${user.email}</small></div>
                        <button class="btn-sm-text btn-approve" onclick="window.updateStatus('${id}', 'Aprovado')">Aprovar</button>
                    </div>`;
            }

            // Tabela Geral
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${user.nome}</strong><br><small>${user.escola || ''}</small></td>
                <td>${user.email}</td>
                <td><span class="role-tag ${user.role === 'ADM' ? 'tag-adm' : 'tag-prof'}">${user.role}</span></td>
                <td><span class="status-badge status-${user.status}">${user.status}</span></td>
                <td>
                    <div class="btn-action-group">
                        ${user.status !== 'Aprovado' ? `<button class="btn-sm-text btn-approve" onclick="window.updateStatus('${id}', 'Aprovado')"><i class="fas fa-check"></i> Aprovar</button>` : ''}
                        <button class="btn-sm-text btn-edit" onclick="window.editUser('${id}')"><i class="fas fa-edit"></i> Editar</button>
                        <button class="btn-sm-text btn-suspend" onclick="window.updateStatus('${id}', 'Suspenso')"><i class="fas fa-ban"></i> Suspender</button>
                        <button class="btn-sm-text btn-delete" onclick="window.deleteUser('${id}')"><i class="fas fa-trash"></i> Excluir</button>
                    </div>
                </td>`;
            tableBody.appendChild(tr);
        });

        if (!hasPending) pendingList.innerHTML = '<p style="text-align:center; color:#94a3b8;">Nenhum pendente encontrado.</p>';
    });

    // A√ß√µes
    window.updateStatus = (id, newStatus) => update(ref(db, `usuarios/${id}`), { status: newStatus });
    window.deleteUser = (id) => confirm("Excluir usu√°rio permanentemente?") && remove(ref(db, `usuarios/${id}`));

    window.editUser = (id) => {
        onValue(ref(db, `usuarios/${id}`), (snap) => {
            const user = snap.val();
            document.getElementById('edit-user-id').value = id;
            document.getElementById('new-user-name').value = user.nome;
            document.getElementById('new-user-school').value = user.escola || '';
            document.getElementById('new-user-email').value = user.email;
            document.getElementById('new-user-password').value = user.password_hash || ''; // Puxa a senha do banco
            document.getElementById('new-user-role').value = user.role;
            
            document.getElementById('btn-save-user').innerText = "Atualizar Usu√°rio";
            document.getElementById('btn-cancel-edit').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, { onlyOnce: true });
    };

    document.getElementById('btn-save-user').onclick = async () => {
        const id = document.getElementById('edit-user-id').value;
        const data = {
            nome: document.getElementById('new-user-name').value.toUpperCase(),
            escola: document.getElementById('new-user-school').value.toUpperCase(),
            email: document.getElementById('new-user-email').value,
            password_hash: document.getElementById('new-user-password').value,
            role: document.getElementById('new-user-role').value,
            cargo: document.getElementById('new-user-role').value === 'ADM' ? 'ADMINISTRADOR' : 'PROFESSOR',
            status: "Aprovado" // Ao salvar/editar vira aprovado por padr√£o
        };

        if(id) await update(ref(db, `usuarios/${id}`), data);
        else await push(ref(db, 'usuarios'), { ...data, data_solicitacao: new Date().toISOString() });
        
        resetForm();
    };

    document.getElementById('btn-cancel-edit').onclick = resetForm;

    function resetForm() {
        document.getElementById('edit-user-id').value = '';
        document.querySelectorAll('#admin-form input').forEach(i => i.value = '');
        document.getElementById('btn-save-user').innerText = "Salvar Usu√°rio";
        document.getElementById('btn-cancel-edit').style.display = 'none';
    }

    window.filterTable = () => {
        const term = document.getElementById('admin-search').value.toLowerCase();
        const rows = document.querySelectorAll('#users-table-body tr');
        rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(term) ? '' : 'none');
    };
</script>
            
        </main>
        
        <footer>
            By Atecseven tecnologia - www.atecseven.com.br - CNPJ 63.373.374/0001-72
        </footer>
    </div>
    
    <div id="print-area-container">
        </div>

    <div id="modal-request-access" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-btn" onclick="closeModal('modal-request-access')">&times;</span>
            <h3><i class="fas fa-user-plus"></i> Solicitar Acesso</h3>
            
            <p class="alert-info"><i class="fas fa-info-circle"></i> Sua solicita√ß√£o ser√° enviada para aprova√ß√£o do Administrador.</p>
            
            <form id="form-request-access" onsubmit="return false;">
                <label for="access-name">Nome Completo:</label>
                <input type="text" id="access-name" required>

                <label for="access-cargo">Cargo/Fun√ß√£o:</label>
<select id="access-cargo" required style="
    width: 100%; 
    padding: 10px; 
    border-radius: 8px; 
    border: 1px solid #e2e8f0; 
    background-color: white;
    font-size: 1rem;
    color: #1e293b;
    cursor: pointer;
    outline: none;
    transition: border-color 0.2s;
">
    <option value="" disabled selected>Selecione seu cargo</option>
    <option value="Professor">Professor</option>
</select>

                <label for="access-escola">Nome da Escola/Institui√ß√£o:</label>
                <input type="text" id="access-escola" required>

                <label for="access-email">E-mail (Ser√° seu login):</label>
                <input type="email" id="access-email" required>
                
                <label for="access-password">Senha:</label>
                <input type="password" id="access-password" required>
                
                <button type="button" class="btn-primary" onclick="handleRequestAccess()"><i class="fas fa-paper-plane"></i> Enviar Solicita√ß√£o</button>
            </form>
            <div id="request-access-message" style="margin-top: 10px;"></div>
        </div>
    </div>
<!--/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner       ATECSEVEN TECNOLOGIA
 * @cnpj        63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */-->

    <div id="modal-question-view" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('modal-question-view')">&times;</span>
            <h3 id="modal-question-title">Visualizar Quest√£o Q0</h3>
            
            <div id="modal-question-content" class="question-view-grid">
                <div>
                    <h4>Enunciado</h4>
                    <p id="modal-enunciado-text"></p>
                    <img id="modal-enunciado-image" class="question-image-preview" alt="Imagem do Enunciado" style="display: none;">
                </div>
                
                <div>
                    <h4>Alternativas / Gabarito</h4>
                    <form id="modal-gabarito-form">
                        <ul id="modal-alternatives-list" class="alternatives-list">
                            </ul>
                        <p>Resposta Correta Atual: <strong id="modal-resposta-correta-atual"></strong></p>
                        <input type="hidden" id="modal-question-id">
                        <button type="button" class="btn-primary" onclick="saveNewAnswer()"><i class="fas fa-check"></i> Salvar Nova Alternativa</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-question-edit" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close-btn" onclick="closeModal('modal-question-edit')">&times;</span>
            <h3 id="modal-edit-question-title">Editar Quest√£o Q0</h3>

            <form id="form-edit-question">
                <input type="hidden" id="edit-question-firebaseId">
                <input type="hidden" id="edit-question-id-sequencial">
                
                <div class="dashboard-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div>
                        <label for="edit-modalidade">Modalidade de Ensino:</label>
                        <select id="edit-modalidade" required>
                            <option value="Ensino Fundamental I">Ensino Fundamental I</option>
                            <option value="Ensino Fundamental II">Ensino Fundamental II</option>
                            <option value="Ensino M√©dio">Ensino M√©dio</option>
                        </select>

                        <label for="edit-componente">Componente Curricular:</label>
                        <input type="text" id="edit-componente" placeholder="Ex: Matem√°tica, Portugu√™s, Ci√™ncias" required>
                        
                        <label for="edit-habilidade">Habilidade BNCC (D-XX):</label>
                        <input type="text" id="edit-habilidade" placeholder="Ex: D 33">
                        
                        <label for="edit-tipo">Tipo de Quest√£o:</label>
                        <select id="edit-tipo" onchange="toggleEditAlternatives(this.value)" required>
                            <option value="M√∫ltipla Escolha">M√∫ltipla Escolha</option>
                            <option value="Discursiva">Discursiva</option>
                        </select>
                        
                         <div id="edit-linhas-discursiva-group" style="display: none;">
                            <label for="edit-linhas-discursiva">Linhas para Resposta Discursiva (padr√£o 4):</label>
                            <input type="number" id="edit-linhas-discursiva" min="1" max="20" value="4">
                        </div>

                    </div>
                    <div>
                        <label for="edit-enunciado">Enunciado da Quest√£o (Texto):</label>
                        <textarea id="edit-enunciado" rows="5" required></textarea>
                        
                        <label for="edit-enunciado-imagem">Imagem/M√≠dia para o Enunciado (Selecione um novo arquivo para substituir):</label>
                        <input type="file" id="edit-enunciado-imagem" accept="image/*">
                        <div id="edit-enunciado-image-preview-container">
                             <small>Imagem Atual:</small>
                             <img id="edit-enunciado-image-preview" class="image-preview-edit" alt="Imagem Enunciado Atual" style="display: none;">
                        </div>
                    </div>
                </div>
<!--/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner       ATECSEVEN TECNOLOGIA
 * @cnpj        63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */-->
                <div id="edit-alternatives-section">
                    <h3 style="margin-top: 30px;">Edi√ß√£o de Alternativas</h3>
                    <div id="edit-alternatives-inputs" class="dashboard-grid" style="grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        </div>
                    
                    <label for="edit-resposta-correta">Resposta Correta:</label>
                    <select id="edit-resposta-correta" required>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                    </select>
                </div>

                <button type="button" class="btn-primary" style="margin-top: 20px;" onclick="handleEditQuestionSave()"><i class="fas fa-save"></i> Salvar Edi√ß√£o da Quest√£o</button>
                <div id="question-edit-message" style="margin-top: 20px;"></div>
            </form>
        </div>
    </div>


    <div id="modal-edit-exam" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('modal-edit-exam')">&times;</span>
            <h3>Editar Prova <span id="modal-edit-exam-name"></span></h3>
            
            <p class="alert-info"><i class="fas fa-info-circle"></i> Edi√ß√£o de Cabe√ßalho: Para alterar quest√µes, exclua e gere uma nova prova.</p>
            
            <form id="form-edit-exam">
                <label for="edit-escola">Nome da Escola:</label>
                <input type="text" id="edit-escola" required>
                
                <label for="edit-turma">Turma:</label>
                <input type="text" id="edit-turma" required>
                
                <label for="edit-professor">Professor:</label>
                <input type="text" id="edit-professor" required>
                
                <label for="edit-duracao">Dura√ß√£o:</label>
                <input type="text" id="edit-duracao" required>
                
                <label for="edit-data-prova">Data da Prova:</label>
                <input type="date" id="edit-data-prova" required>
                
                <button type="button" class="btn-primary" onclick="handleEditExamSave()"><i class="fas fa-save"></i> Salvar Altera√ß√µes</button>
            </form>
            <div id="edit-exam-message" style="margin-top: 10px;"></div>
        </div>
    </div>
<!--/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner       ATECSEVEN TECNOLOGIA
 * @cnpj        63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */-->

    <script>
      /**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner        ATECSEVEN TECNOLOGIA
 * @cnpj         63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 *//**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner        ATECSEVEN TECNOLOGIA
 * @cnpj         63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */
    const IMGBB_KEY = "95bb16ee776d7e20f26857cec98bd372";
    /**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner        ATECSEVEN TECNOLOGIA
 * @cnpj         63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */
    const firebaseConfig = {
    apiKey: "AIzaSyCSeSmkMM_4-NlLv8Js_ODwA4H372yq48k",
    authDomain: "rnc-sgt.firebaseapp.com",
    databaseURL: "https://rnc-sgt-default-rtdb.firebaseio.com",
    projectId: "rnc-sgt",
    storageBucket: "rnc-sgt.firebasestorage.app",
    messagingSenderId: "500336948308",
    appId: "1:500336948308:web:a6448b9141974f542ce9c1",
    measurementId: "G-LB9EQPJRQ1"
};
/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner        ATECSEVEN TECNOLOGIA
 * @cnpj         63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */
    const app = firebase.initializeApp(firebaseConfig);
    const database = app.database();

    let CURRENT_USER = null;    
    let CURRENT_USER_ID = null;
    let CURRENT_USER_ROLE = 'Padr√£o';    
    let allUsers = {};  
    let allExams = {};  
    let allQuestions = {};  
    let selectedExamId = null;
    let selectedQuestionIdsForExam = [];

    const ALTERNATIVE_LETTERS = ['A', 'B', 'C', 'D', 'E'];
    const LINE_HEIGHT_PT = 14;  
/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner        ATECSEVEN TECNOLOGIA
 * @cnpj         63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */
    let PAGE_SIZE = 20; 
    let lastKey = null; 
    let isSearching = false; 

    async function uploadFileToImgBB(file) {
        if (!file) return "";

        const formData = new FormData();
        formData.append("image", file);
        
        const url = `https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Erro de rede ou falha no upload: ${response.statusText}`);
            }
            
            const data = await response.json();

            if (data.success) {
                return data.data.url;
            } else {
                throw new Error(data.error.message || "Erro desconhecido no ImgAtecServer.");
            }
        } catch (error) {
            console.error("Erro no upload para ImgAtecServer:", error);
            throw new Error(`Falha no upload da imagem. Erro: ${error.message}`);
        }
    }
    /**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner        ATECSEVEN TECNOLOGIA
 * @cnpj         63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */
    async function handleLogin() {
        const email = document.getElementById('login-user').value;
        const password = document.getElementById('login-password').value;
        const messageEl = document.getElementById('login-message');
        messageEl.innerHTML = '<i class="fas fa-sync fa-spin"></i> Verificando credenciais...';
        
        try {
            const userSnapshot = await database.ref('usuarios').orderByChild('email').equalTo(email).once('value');
            
            if (!userSnapshot.exists()) {
                 messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-exclamation-circle"></i> Usu√°rio n√£o encontrado.</div>`;
                 return;
            }

            let userId = null;
            let userDetails = null;

            userSnapshot.forEach(child => {
                userId = child.key;
                userDetails = child.val();
            });

            if (userDetails && userDetails.password_hash === password) {
                
                if (userDetails.status === 'Pendente') {
                    messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-user-clock"></i> Seu acesso est√° pendente de aprova√ß√£o pelo administrador.</div>`;
                    return;
                }

                CURRENT_USER_ID = userId;
                CURRENT_USER_ROLE = userDetails.role;
                CURRENT_USER = userDetails;

                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-interface').style.display = 'flex';
                
                const nome = userDetails.nome || userDetails.email;
                const userInfoDisplay = document.getElementById('user-info-display');
                if (userInfoDisplay) {
                    userInfoDisplay.textContent = ` | Seja Bem-Vindo(a) ${nome}`;
                }
                
                document.getElementById('user-role-display').textContent = `[${CURRENT_USER_ROLE}]`;
                
                if (CURRENT_USER_ROLE === 'ADM') {
                    document.getElementById('nav-admin').style.display = 'list-item';
                } else {
                    document.getElementById('nav-admin').style.display = 'none';
                }
                
                document.getElementById('cabecalho-professor').value = nome;
                document.getElementById('cabecalho-professor').disabled = true;

                await updateDashboardIndicators();
                showPage('dashboard');

            } else {
                messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-exclamation-circle"></i> Senha incorreta.</div>`;
            }

        } catch (error) {
            console.error("Erro no login:", error);
            messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-radiation-alt"></i> Erro de conex√£o: ${error.message}</div>`;
        }
    }
    
    async function handleRequestAccess() {
        const name = document.getElementById('access-name').value;
        const cargo = document.getElementById('access-cargo').value;
        const escola = document.getElementById('access-escola').value;
        const email = document.getElementById('access-email').value;
        const password = document.getElementById('access-password').value;

        const messageEl = document.getElementById('request-access-message');
        messageEl.innerHTML = '';

        if (!name || !cargo || !escola || !email || !password) {
            messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-exclamation-triangle"></i> Todos os campos s√£o obrigat√≥rios.</div>`;
            return;
        }
        
        try {
            const existingUserSnapshot = await database.ref('usuarios').orderByChild('email').equalTo(email).once('value');
            if (existingUserSnapshot.exists()) {
                 messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-user-lock"></i> Este e-mail j√° est√° cadastrado. Tente entrar.</div>`;
                 return;
            }
/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner        ATECSEVEN TECNOLOGIA
 * @cnpj         63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */
            const newUserRef = database.ref('usuarios').push();
            await newUserRef.set({
                nome: name,
                cargo: cargo,
                escola: escola,
                email: email,
                password_hash: password,    
                role: 'Padr√£o',
                status: 'Pendente',
                data_solicitacao: new Date().toISOString()
            });
            
            messageEl.innerHTML = `<div class="alert-success"><i class="fas fa-check-circle"></i> Solicita√ß√£o enviada! Aguarde a aprova√ß√£o do administrador.</div>`;
            document.getElementById('form-request-access').reset();
            
        } catch (error) {
            messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-exclamation-circle"></i> Erro ao enviar solicita√ß√£o: ${error.message}</div>`;
        }
    }
    
    function showPage(pageId) {
        document.querySelectorAll('.page-section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(pageId).style.display = 'block';
        
        document.querySelectorAll('.nav-menu a').forEach(a => a.classList.remove('active'));
        document.getElementById(`nav-${pageId.replace('-', '')}`).classList.add('active');
        
        if (pageId === 'bank') {
            updateBankView();
        } else if (pageId === 'my-exams') {
            if(Object.keys(allExams).length === 0) updateExamListView();
            else filterExams();    
            document.getElementById('exam-details-view').style.display = 'none';
        } else if (pageId === 'admin') {
            if (CURRENT_USER_ROLE === 'ADM') {
                updateAdminViews();
            }
        } else if (pageId === 'dashboard') {
            updateDashboardIndicators();
        } else if (pageId === 'create-exam') {
            if(selectedQuestionIdsForExam.length > 0) {
                displaySelectedQuestionsForExam(selectedQuestionIdsForExam);
            } else {
                document.getElementById('selected-questions-from-bank').style.display = 'none';
                document.getElementById('exam-questions-list').innerHTML = '<p>Selecione uma disciplina acima ou use o Banco de Quest√µes para carregar as quest√µes.</p>';
            }
        }
    }

    function simularLogout() {
        CURRENT_USER = null;
        CURRENT_USER_ID = null;
        CURRENT_USER_ROLE = 'Padr√£o';
        document.getElementById('main-interface').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('login-user').value = '';    
        document.getElementById('login-password').value = '';
        document.getElementById('login-message').innerHTML = '';
        
        allQuestions = {};
        allExams = {};
    }

    function formatDateTimeBR(isoString) {
        if (!isoString) return 'N/A';
        const date = new Date(isoString);
        return date.toLocaleString('pt-BR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
    }
 
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    async function getNextQuestionId() {
        const counterRef = database.ref('metadata/questionCounter');
        
        const { committed, snapshot } = await counterRef.transaction(currentValue => {
            return (currentValue || 0) + 1;
        });

        if (committed) {
            return snapshot.val();
        } else {
            const currentSnapshot = await counterRef.once('value');
            return currentSnapshot.val();    
        }
    }
    
    let originalUsersList = [];

    async function updateAdminViews() {
        try {
            const snapshot = await database.ref('usuarios').once('value');
            allUsers = snapshot.val() || {};
            
            originalUsersList = Object.entries(allUsers).map(([id, user]) => ({ id, ...user }));
            
            const totalPadrao = originalUsersList.filter(u => u.status === 'Aprovado' && u.role === 'Padr√£o').length;
            const totalAdm = originalUsersList.filter(u => u.status === 'Aprovado' && u.role === 'ADM').length;
            const totalPendentes = originalUsersList.filter(u => u.status === 'Pendente').length;
            
            document.getElementById('dash-total-padrao').textContent = totalPadrao;
            document.getElementById('dash-total-adm').textContent = totalAdm;
            document.getElementById('dash-total-pendentes').textContent = totalPendentes;
            
            filterUsers();
            
        } catch (e) {
            console.error("Erro ao carregar usu√°rios (ADM):", e);
        }
    }
    
    function filterUsers() {
        const pendingList = document.getElementById('pending-users-list');
        const activeList = document.getElementById('active-users-list');
        pendingList.innerHTML = '';
        activeList.innerHTML = '';
        
        const filterText = document.getElementById('filter-users-text').value.toLowerCase();
        
        const filteredUsers = originalUsersList.filter(u => u.email.toLowerCase().includes(filterText));
        
        const pending = filteredUsers.filter(u => u.status === 'Pendente');
        const active = filteredUsers.filter(u => u.status === 'Aprovado');
        
        if (pending.length === 0) pendingList.innerHTML = '<li>Nenhum usu√°rio pendente ou encontrado com o filtro.</li>';
        pending.forEach(u => {
            pendingList.innerHTML += `
                <li>
                    <span>${u.email} (Nome: ${u.nome || 'N/A'} | Escola: ${u.escola || 'N/A'})</span>
                    <div>
                        <button class="action-button btn-primary" onclick="changeUserStatus('${u.id}', 'Aprovado')"><i class="fas fa-check"></i> Aprovar</button>
                        <button class="action-button btn-danger" onclick="deleteUser('${u.id}')"><i class="fas fa-trash"></i> Excluir</button>
                    </div>
                </li>
            `;
        });
        
        if (active.length === 0) activeList.innerHTML = '<li>Nenhum usu√°rio ativo ou encontrado com o filtro.</li>';
        active.forEach(u => {
            activeList.innerHTML += `
                <li>
                    <span>${u.email} (Fun√ß√£o: ${u.role})</span>
                    <div>
                        <button class="action-button btn-secondary" onclick="resetUserPassword('${u.id}')"><i class="fas fa-redo"></i> Resetar Senha</button>
                        <button class="action-button btn-danger" onclick="deleteUser('${u.id}')"><i class="fas fa-trash"></i> Excluir</button>
                    </div>
                </li>
            `;
        });
    }

    async function handleCreateUser() {
        const name = document.getElementById('new-user-name').value;
        const email = document.getElementById('new-user-email').value;
        const password = document.getElementById('new-user-password').value;
        const role = document.getElementById('new-user-role').value;
        const messageEl = document.getElementById('create-user-message');
        messageEl.innerHTML = `<div class="alert-info"><i class="fas fa-sync fa-spin"></i> Criando usu√°rio...</div>`;
        
        try {
            const newUserRef = database.ref('usuarios').push();
            await newUserRef.set({
                nome: name,
                email: email,
                password_hash: password,    
                role: role,
                status: 'Aprovado',
                data_criacao: new Date().toISOString()
            });
            
            messageEl.innerHTML = `<div class="alert-success"><i class="fas fa-check-circle"></i> Usu√°rio ${email} criado com sucesso!</div>`;
            document.getElementById('form-create-user').reset();
            updateAdminViews();
        } catch (error) {
            messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-exclamation-circle"></i> Erro ao criar usu√°rio: ${error.message}</div>`;
        }
    }

    async function changeUserStatus(userId, status) {
        try {
            await database.ref(`usuarios/${userId}`).update({ status: status });
            alert(`Status do usu√°rio alterado para: ${status}`);
            updateAdminViews();
        } catch (e) {
            alert("Erro ao mudar status: " + e.message);
        }
    }

    async function resetUserPassword(userId) {
        const newPassword = prompt("Digite a nova senha para este usu√°rio:");
        if (newPassword) {
            try {
                await database.ref(`usuarios/${userId}`).update({ password_hash: newPassword });
                alert(`Senha resetada com sucesso! Nova senha: ${newPassword}`);
                updateAdminViews();
            } catch (e) {
                alert("Erro ao resetar senha: " + e.message);
            }
        }
    }

    async function deleteUser(userId) {
        if (confirm("Tem certeza que deseja EXCLUIR este usu√°rio?")) {
            try {
                await database.ref(`usuarios/${userId}`).remove();
                alert("Usu√°rio exclu√≠do com sucesso.");
                updateAdminViews();
            } catch (e) {
                alert("Erro ao excluir usu√°rio: " + e.message);
            }
        }
    }

    function setupAlternativeInputs() {
        const container = document.getElementById('alternatives-inputs');
        container.innerHTML = '';
        ALTERNATIVE_LETTERS.forEach(letra => {
            container.innerHTML += `
                <div>
                    <label for="alt${letra}"><strong>${letra})</strong> Texto:</label>
                    <input type="text" id="alt${letra}" placeholder="Texto da alternativa ${letra}" required>
                    <label for="img${letra}">M√≠dia ${letra} (Opcional):</label>
                    <input type="file" id="img${letra}" accept="image/*">
                </div>
            `;
        });
    }
    
    async function handleCreateQuestion() {
        const messageEl = document.getElementById('question-creation-message');
        messageEl.innerHTML = `<div class="alert-info"><i class="fas fa-sync fa-spin"></i> Processando... Uploads para ImgAtecServer em andamento.</div>`;
        
        try {
            const nextId = await getNextQuestionId();
            
            const enunciadoFile = document.getElementById('enunciado-imagem').files[0];
            const enunciadoUrl = await uploadFileToImgBB(enunciadoFile);

            const tipo = document.getElementById('tipo').value;
            const linhasDiscursivaEl = document.getElementById('linhas-discursiva');
            const linhasDiscursiva = tipo === 'Discursiva' && linhasDiscursivaEl ? parseInt(linhasDiscursivaEl.value) : 0;
            
            const alternativas = [];
            if (tipo === 'M√∫ltipla Escolha') {
                for (const letra of ALTERNATIVE_LETTERS) {
                    const altText = document.getElementById(`alt${letra}`).value;
                    const altFile = document.getElementById(`img${letra}`).files[0];
                    let midiaUrl = "";
                    if (altFile) {
                        midiaUrl = await uploadFileToImgBB(altFile);
                    }
                    
                    alternativas.push({
                        letra: letra,
                        texto: altText,
                        midia: midiaUrl
                    });
                }
            }
            
            const novaQuestaoRef = database.ref('banco_questoes').push();
            const dadosQuestao = {
                id_sequencial: nextId,
                firebaseId: novaQuestaoRef.key,
                modalidade: document.getElementById('modalidade').value,
                componente_curricular: document.getElementById('componente').value,
                habilidade_bncc: document.getElementById('habilidade').value,
                enunciado: { texto: document.getElementById('enunciado').value, midia: enunciadoUrl || "" },
                tipo_questao: tipo,
                alternativas: alternativas,
                resposta_correta: tipo === 'M√∫ltipla Escolha' ? document.getElementById('resposta-correta').value : "Discursiva",
                linhas_discursiva: linhasDiscursiva,
                data_criacao: new Date().toISOString(),
                criado_por_uid: CURRENT_USER_ID
            };

            await novaQuestaoRef.set(dadosQuestao);
            
            messageEl.innerHTML = `<div class="alert-success"><i class="fas fa-check-circle"></i> Quest√£o Q${nextId} salva com sucesso! (Imagens no ImgAtecServer)</div>`;
            document.getElementById('form-create-question').reset();
            setupAlternativeInputs();    
            updateBankView();
            updateDashboardIndicators();
            
        } catch (error) {
            console.error("Erro ao criar quest√£o:", error);
            messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-exclamation-circle"></i> Erro ao salvar a quest√£o: ${error.message}</div>`;
        }
    }
    
    //BANCO DE QUEST√ïES DAQUI PRA BAIXO
    function displayQuestions(questoes) {
    const listEl = document.getElementById('questions-bank-list');
    
    // Inje√ß√£o de CSS Profissional (Executado apenas uma vez)
    if (!document.getElementById('styled-questions-css')) {
        const style = document.createElement('style');
        style.id = 'styled-questions-css';
        style.innerHTML = `
            #questions-bank-list {
                list-style: none;
                padding: 0;
                margin: 0;
                font-family: 'Inter', system-ui, -apple-system, sans-serif;
            }
            .question-card {
                display: flex;
                align-items: flex-start;
                gap: 15px;
                background: #ffffff;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 12px;
                transition: all 0.2s ease;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            .question-card:hover {
                border-color: #3b82f6;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                transform: translateY(-1px);
            }
            .question-card input[type="checkbox"] {
                width: 18px;
                height: 18px;
                margin-top: 4px;
                cursor: pointer;
                accent-color: #3b82f6;
            }
            .question-item-info {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                gap: 4px;
            }
            .question-title {
                font-size: 0.95rem;
                color: #1e293b;
                line-height: 1.5;
            }
            .question-title strong {
                color: #3b82f6;
                margin-right: 4px;
            }
            .question-metadata {
                font-size: 0.8rem;
                color: #64748b;
                display: flex;
                gap: 12px;
                align-items: center;
            }
            .badge-res {
                background: #f1f5f9;
                padding: 2px 8px;
                border-radius: 4px;
                font-weight: 600;
                color: #475569;
            }
            .question-item-actions {
                display: flex;
                gap: 8px;
                white-space: nowrap;
            }
            .action-button {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 0.85rem;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s;
                border: 1px solid transparent;
            }
            .btn-secondary { background: #f8fafc; border-color: #e2e8f0; color: #475569; }
            .btn-secondary:hover { background: #f1f5f9; border-color: #cbd5e1; }
            .btn-primary { background: #3b82f6; color: white; }
            .btn-primary:hover { background: #2563eb; }
            
            @media (max-width: 600px) {
                .question-card { flex-direction: column; }
                .question-item-actions { width: 100%; justify-content: flex-end; }
            }
        `;
        document.head.appendChild(style);
    }

    // Limpa a lista antes de renderizar (opcional, dependendo da sua l√≥gica de app)
    listEl.innerHTML = '';

    const questionsToDisplay = questoes.sort((a, b) => a.id_sequencial - b.id_sequencial);

    if (questionsToDisplay.length > 0) {
        questionsToDisplay.forEach(q => {
            const isChecked = selectedQuestionIdsForExam.includes(q.firebaseId);
            
            const listItem = document.createElement('li');
            listItem.className = 'question-card';
            listItem.setAttribute('data-id', q.firebaseId);
            
            listItem.innerHTML = `
                <input type="checkbox" 
                       name="select_for_exam" 
                       value="${q.firebaseId}" 
                       ${isChecked ? 'checked' : ''} 
                       onchange="toggleQuestionSelection('${q.firebaseId}', this.checked)">
                
                <div class="question-item-info">
                    <span class="question-title">
                        <strong>Q${q.id_sequencial}</strong> 
                        <span style="color: #94a3b8;">[${q.componente_curricular} ‚Ä¢ ${q.modalidade}]</span> 
                        ${q.enunciado.texto.substring(0, 85)}...
                    </span>
                    <div class="question-metadata">
                        <span><span class="badge-res">Gabarito: ${q.resposta_correta}</span></span>
                        <span><i class="fas fa-tag"></i> ${q.habilidade_bncc || 'N/A'}</span>
                    </div>
                </div>

                <div class="question-item-actions">
                    <button class="action-button btn-secondary" onclick="openQuestionViewModal('${q.firebaseId}')">
                        <i class="fas fa-eye"></i> Gabarito
                    </button>
                    <button class="action-button btn-primary" onclick="openQuestionEditModal('${q.firebaseId}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </div>
            `;
            listEl.appendChild(listItem);
        });
    }
}

    // NOVO: Fun√ß√£o para adicionar o bot√£o "Carregar Mais"
    function addLoadMoreButton(hasNextPage) {
        const listEl = document.getElementById('questions-bank-list');
        
        const existingButton = document.querySelector('#bank #load-more-btn');
        if (existingButton) existingButton.remove();

        if (hasNextPage) {
            const loadMoreBtn = document.createElement('button');
            loadMoreBtn.id = 'load-more-btn';
            loadMoreBtn.className = 'btn-secondary';
            loadMoreBtn.style = 'margin-top: 20px; width: 100%;';
            loadMoreBtn.innerHTML = '<i class="fas fa-arrow-down"></i> Carregar Mais Quest√µes';
            loadMoreBtn.onclick = () => manageBankPagination(false); 
            
            listEl.parentNode.insertBefore(loadMoreBtn, listEl.nextSibling);
        }
    }

    // NOVO: Fun√ß√£o de Pagina√ß√£o Mestra
    async function manageBankPagination(reset = false) {
        if (isSearching && !reset) return; 
        isSearching = true;

        const listEl = document.getElementById('questions-bank-list');
        const filterText = document.getElementById('filter-bank-text').value.toLowerCase();
        const filterModalidade = document.getElementById('filter-bank-modalidade').value;
        
        if (reset) {
            lastKey = null;
            listEl.innerHTML = ''; 
        }
        
        if (listEl.children.length === 0) {
             listEl.innerHTML = '<li style="text-align:center;"><i class="fas fa-sync fa-spin"></i> Carregando quest√µes...</li>';
        }
        
        const existingButton = document.querySelector('#bank #load-more-btn');
        if (existingButton) existingButton.remove();

        try {
            let queryRef = database.ref('banco_questoes').orderByKey();
            
            if (lastKey) {
                queryRef = queryRef.startAt(lastKey);
            }
            
            queryRef = queryRef.limitToFirst(PAGE_SIZE + 1);

            const snapshot = await queryRef.once('value');
            let newQuestionsArray = [];
            let lastIdInPage = null; 

            snapshot.forEach(child => {
                const currentKey = child.key;
                
                if (lastKey && currentKey === lastKey && newQuestionsArray.length === 0 && !reset) {
                    return;
                }

                const q = { firebaseId: currentKey, ...child.val() };
                
                const modalidadeMatch = !filterModalidade || q.modalidade === filterModalidade;
                const textMatch = !filterText || 
                                    q.componente_curricular.toLowerCase().includes(filterText) ||
                                    (q.habilidade_bncc && q.habilidade_bncc.toLowerCase().includes(filterText)) ||
                                    q.enunciado.texto.toLowerCase().includes(filterText);

                if (modalidadeMatch && textMatch) {
                    newQuestionsArray.push(q);
                    allQuestions[currentKey] = q; 
                    lastIdInPage = currentKey;
                }
            });

            const totalItemsFetched = snapshot.numChildren();
            
            const hasNextPage = newQuestionsArray.length >= PAGE_SIZE;

            lastKey = hasNextPage ? lastIdInPage : null; 
            
            if(reset) {
                listEl.innerHTML = '';
            }
            
            // Remove o item de controle do final do array se ele n√£o for o √∫ltimo item vis√≠vel
            if(newQuestionsArray.length > PAGE_SIZE) {
                newQuestionsArray.pop();
            }

            displayQuestions(newQuestionsArray);

            if (listEl.children.length === 0) {
                 listEl.innerHTML = '<li>Nenhuma quest√£o encontrada com os filtros aplicados.</li>';
            }

            addLoadMoreButton(hasNextPage);

        } catch (e) {
            listEl.innerHTML = `<li><div class="alert-error"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar quest√µes: ${e.message}</div></li>`;
            console.error("Erro no manageBankPagination:", e);
        } finally {
            isSearching = false;
        }
    }

    async function updateBankView() {
        const snapshot = await database.ref('banco_questoes').once('value');
        allQuestions = snapshot.val() || {};
        
        const selectDisciplina = document.getElementById('cabecalho-disciplina-select');
        const disciplinas = new Set(Object.values(allQuestions).map(q => q.componente_curricular).filter(c => c));
        selectDisciplina.innerHTML = '<option value="">Selecione a Disciplina</option>';
        disciplinas.forEach(d => {
            selectDisciplina.innerHTML += `<option value="${d}">${d}</option>`;
        });
        
        manageBankPagination(true);
    }
    
    function selectAllQuestions(checked) {
        const checkboxes = document.querySelectorAll('#questions-bank-list input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = checked;
            toggleQuestionSelection(cb.value, checked);
        });
    }

    function filterQuestions() {
        manageBankPagination(true);
    }
    
    function toggleQuestionSelection(questionId, isChecked) {
        if (isChecked) {
            if (!selectedQuestionIdsForExam.includes(questionId)) {
                selectedQuestionIdsForExam.push(questionId);
            }
        } else {
            selectedQuestionIdsForExam = selectedQuestionIdsForExam.filter(id => id !== questionId);
        }
    }

    function sendSelectedToExam() {
        if (selectedQuestionIdsForExam.length === 0) {
            alert("Selecione pelo menos uma quest√£o para enviar para a prova.");
            return;
        }
        
        displaySelectedQuestionsForExam(selectedQuestionIdsForExam);
        showPage('create-exam');
        
        alert(`${selectedQuestionIdsForExam.length} quest√£o(√µes) enviada(s) para a tela "Gerar Prova".`);
    }
    
    function displaySelectedQuestionsForExam(ids) {
        const listEl = document.getElementById('exam-questions-list');
        listEl.innerHTML = '';
        
        const questoesDetalhes = ids.map(id => allQuestions[id]).filter(q => q);
        
        if (questoesDetalhes.length > 0) {
            const disciplina = questoesDetalhes[0].componente_curricular;
            document.getElementById('cabecalho-disciplina-select').value = disciplina;
            document.getElementById('selected-questions-from-bank').style.display = 'block';
            document.getElementById('selected-questions-from-bank').innerHTML = `<i class="fas fa-info-circle"></i> <strong>Quest√µes carregadas do Banco.</strong> Disciplina: <strong>${disciplina}</strong>. Total: <strong>${questoesDetalhes.length}</strong>. Voc√™ pode desmarcar.`;

            listEl.innerHTML = '<h4><i class="fas fa-check-square"></i> Quest√µes Carregadas (Desmarque para remover):</h4><ul style="list-style: none; padding: 0;">';
            
            questoesDetalhes.forEach(q => {
                listEl.querySelector('ul').innerHTML += `
                    <li data-id="${q.firebaseId}">
                        <label>
                            <input type="checkbox" name="selected_questions" value="${q.firebaseId}" checked>
                            Q${q.id_sequencial} (${q.tipo_questao}): ${q.enunciado.texto.substring(0, 70)}...
                        </label>
                        <button class="action-button btn-secondary btn-sm" onclick="openQuestionViewModal('${q.firebaseId}')"><i class="fas fa-eye"></i> Visualizar</button>
                    </li>
                `;
            });
            listEl.innerHTML += '</ul>';
        } else {
            document.getElementById('selected-questions-from-bank').style.display = 'none';
            listEl.innerHTML = '<p class="alert-error"><i class="fas fa-exclamation-triangle"></i> Nenhuma quest√£o v√°lida selecionada ou carregada.</p>';
        }
    }

    function shuffleSelectedQuestions() {
        if (selectedQuestionIdsForExam.length < 2) return alert("Adicione mais quest√µes para embaralhar.");
        
        for (let i = selectedQuestionIdsForExam.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [selectedQuestionIdsForExam[i], selectedQuestionIdsForExam[j]] = [selectedQuestionIdsForExam[j], selectedQuestionIdsForExam[i]];
        }
        
        displaySelectedQuestionsForExam(selectedQuestionIdsForExam);
        alert("Quest√µes embaralhadas!");
    }


    function filterQuestionsForExam() {
        const selectedDiscipline = document.getElementById('cabecalho-disciplina-select').value;
        
        if (selectedQuestionIdsForExam.length > 0) return;
        
        const examListEl = document.getElementById('exam-questions-list');
        examListEl.innerHTML = '';
        document.getElementById('selected-questions-from-bank').style.display = 'none';

        if (!selectedDiscipline) {
            examListEl.innerHTML = '<p class="alert-info"><i class="fas fa-arrow-up"></i> Selecione uma disciplina acima para carregar as quest√µes.</p>';
            return;
        }
        
        const questoesArray = Object.values(allQuestions).sort((a, b) => a.id_sequencial - b.id.sequencial);
        
        const questoesFiltradas = questoesArray.filter(q => q.componente_curricular === selectedDiscipline);

        if (questoesFiltradas.length > 0) {
            examListEl.innerHTML = '<h4><i class="fas fa-check-square"></i> Marque as quest√µes desejadas:</h4><ul style="list-style: none; padding: 0;">';
            
            questoesFiltradas.forEach(q => {
                examListEl.querySelector('ul').innerHTML += `
                    <li data-id="${q.firebaseId}">
                        <label>
                            <input type="checkbox" name="selected_questions" value="${q.firebaseId}">
                            Q${q.id_sequencial} (${q.tipo_questao}): ${q.enunciado.texto.substring(0, 70)}...
                        </label>
                        <button class="action-button btn-secondary btn-sm" onclick="openQuestionViewModal('${q.firebaseId}')"><i class="fas fa-eye"></i> Visualizar</button>
                    </li>
                `;
            });
            examListEl.innerHTML += '</ul>';
        } else {
            examListEl.innerHTML = `<p class="alert-error"><i class="fas fa-exclamation-triangle"></i> Nenhuma quest√£o cadastrada para a disciplina <strong>${selectedDiscipline}</strong>.</p>`;
        }
    }
  //DAQUI PRA CIMA √â BANCOOO
    function gerarGabaritoInstantaneo(questoes) {
        let gabarito = "--- GABARITO OFICIAL ---\n";
        gabarito += "Disciplina: " + (questoes[0]?.componente_curricular || 'N/A') + "\n";
        gabarito += "Total de Quest√µes: " + questoes.length + "\n\n";
        
        questoes.forEach((q, index) => {
            gabarito += `Q${index + 1}: ${q.resposta_correta} (${q.tipo_questao})\n`;
        });
        
        return gabarito;
    }


    async function handleCreateExam() {
        const messageEl = document.getElementById('exam-creation-message');
        messageEl.innerHTML = `<div class="alert-info"><i class="fas fa-sync fa-spin"></i> Processando upload da logo (ImgAtecServer) e gera√ß√£o da prova...</div>`;
        
        try {
            // 1. Valida√ß√£o e Coleta das Quest√µes Marcadas
            const finalSelectedIds = Array.from(document.querySelectorAll('#exam-questions-list input[name="selected_questions"]:checked')).map(cb => cb.value);

            if (finalSelectedIds.length === 0) {
                throw new Error("Selecione pelo menos uma quest√£o para criar a prova.");
            }

            // 2. Upload da Logo
            const logoFile = document.getElementById('cabecalho-logo-file').files[0];
            let logoUrl = "";
            if (logoFile) {
                 logoUrl = await uploadFileToImgBB(logoFile);
            }
            
            // Coletando vari√°veis com seguran√ßa
            const disciplina = document.getElementById('cabecalho-disciplina-select')?.value || '';
            const dataProva = document.getElementById('cabecalho-data-prova')?.value || '';
            const periodo = document.getElementById('cabecalho-periodo')?.value || '';
            const duracao = document.getElementById('cabecalho-duracao')?.value || '';
            const escola = document.getElementById('cabecalho-escola')?.value || '';
            const turma = document.getElementById('cabecalho-turma')?.value || '';
            const turno = document.getElementById('cabecalho-turno')?.value || '';
            const professor = document.getElementById('cabecalho-professor')?.value || '';
            
            // 3. Recupera os detalhes das quest√µes
            const questoesDetalhes = finalSelectedIds.map(id => allQuestions[id]).filter(q => q);
            
            const dadosProva = {
                cabecalho: {
                    escola: escola,
                    logo: logoUrl,
                    turma: turma,
                    turno: turno,
                    disciplina: disciplina,
                    professor: professor,
                    periodo: periodo,  
                    duracao: duracao,  
                    data_prova: dataProva,
                },
                instrucoes_gerais: document.getElementById('instrucoes').value,
                layout_colunas: document.getElementById('layout').value,
                questoes_detalhes: questoesDetalhes,    
                data_geracao: new Date().toISOString(),
                criado_por_uid: CURRENT_USER_ID
            };
            
            try {
                localStorage.setItem('header_config', JSON.stringify({ escola, turma, professor, periodo, turno, duracao }));
            } catch(e) {
                console.warn("Falha ao salvar configura√ß√£o do cabe√ßalho no localStorage:", e);
            }


            const gabarito = gerarGabaritoInstantaneo(questoesDetalhes);
            dadosProva.gabarito = gabarito;

            const novaProvaRef = database.ref('provas').push();
            await novaProvaRef.set(dadosProva);

            messageEl.innerHTML = `<div class="alert-success"><i class="fas fa-trophy"></i> Prova criada e Gabarito gerado com sucesso!</div>`;
            document.getElementById('form-create-exam').reset();
            document.getElementById('cabecalho-data-prova').value = new Date().toISOString().substring(0, 10);
            
            selectedQuestionIdsForExam = [];    
            document.getElementById('selected-questions-from-bank').style.display = 'none';

            await updateExamListView();
            showPage('my-exams');    
            selectExam(novaProvaRef.key);

        } catch (error) {
            console.error("Erro ao criar prova:", error);
            messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-exclamation-circle"></i> Erro ao gerar prova: ${error.message}.</div>`;
        }
    }
    
    async function updateExamListView() {
        const snapshot = await database.ref('provas').once('value');
        allExams = snapshot.val() || {};
        filterExams();  
    }
/**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner        ATECSEVEN TECNOLOGIA
 * @cnpj         63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 *//**
 * ============================================================================
 * üõ°Ô∏è AVISO DE PROPRIEDADE INTELECTUAL E DIREITOS AUTORAIS
 * ============================================================================
 * * @owner        ATECSEVEN TECNOLOGIA
 * @cnpj         63.363.373/0001-72
 * * ESTE C√ìDIGO FONTE √â PROPRIEDADE EXCLUSIVA DA ATECSEVEN TECNOLOGIA.
 * * √â ESTRITAMENTE PROIBIDA a c√≥pia, reprodu√ß√£o, distribui√ß√£o, modifica√ß√£o
 * ou comercializa√ß√£o deste c√≥digo, total ou parcialmente, sem a expressa
 * autoriza√ß√£o por escrito da detentora dos direitos.
 * * A viola√ß√£o destes termos est√° sujeita √†s penalidades previstas na legisla√ß√£o
 * brasileira vigente:
 * - Lei n¬∫ 9.609/98 (Prote√ß√£o da Propriedade Intelectual de Software).
 * - Lei n¬∫ 9.610/98 (Lei de Direitos Autorais).
 * - C√≥digo Penal Brasileiro (Art. 184 - Viola√ß√£o de direito autoral).
 * * O infrator estar√° sujeito a PROCESSO JUDICIAL nas esferas C√≠vel e Criminal,
 * respondendo por perdas e danos e lucros cessantes.
 * * ¬© ATECSEVEN TECNOLOGIA - Todos os direitos reservados.
 * ============================================================================
 */
    function filterExams() {
    const listEl = document.getElementById('my-exams-list');
    const filterInput = document.getElementById('filter-exams-text');
    const displayElement = document.getElementById('user-info-display');
    
    if (!listEl) return;
    
    // Limpeza e Prepara√ß√£o do Container Responsivo
    listEl.innerHTML = '';
    listEl.style.display = "grid";
    listEl.style.gridTemplateColumns = "repeat(auto-fill, minmax(300px, 1fr))";
    listEl.style.gap = "20px";
    listEl.style.padding = "10px 0";

    const filterText = filterInput ? filterInput.value.toLowerCase() : "";
    
    // TRATAMENTO PROFISSIONAL DO NOME:
    // Remove "Seja bem-vindo", "Ol√°", "Professor" e espa√ßos extras
    let nomeLogado = displayElement ? displayElement.innerText.toUpperCase() : "";
    nomeLogado = nomeLogado.replace(/SEJA BEM-VINDO|OL√Å|BEM VINDO|PROFESSOR\(A\)|PROFESSOR/g, "").trim();
    
    // Fun√ß√£o para normalizar strings (remover acentos para compara√ß√£o perfeita)
    const normalizar = (str) => str.toString().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
    const nomeBusca = normalizar(nomeLogado);

    if (typeof allExams === 'undefined' || !allExams) {
        listEl.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #94a3b8;">Carregando banco de dados...</div>';
        return;
    }

    const examsArray = Object.entries(allExams).map(([id, prova]) => ({ id, ...prova }));
    examsArray.sort((a, b) => new Date(b.data_geracao || 0) - new Date(a.data_geracao || 0));

    let encontrados = 0;

    examsArray.forEach(e => {
        try {
            if (!e.cabecalho) return;

            const disciplina = e.cabecalho.disciplina || "Sem Disciplina";
            const professorBD = e.cabecalho.professor || "";
            const profNormalizado = normalizar(professorBD);
            
            // Filtro de Seguran√ßa: O nome do professor no banco deve conter o nome logado (ou vice-versa)
            const √©Dono = nomeBusca === "" || profNormalizado.includes(nomeBusca) || nomeBusca.includes(profNormalizado);
            
            // Filtro de Texto
            const bateBusca = disciplina.toLowerCase().includes(filterText) || 
                              (e.cabecalho.turma || "").toLowerCase().includes(filterText);

            if (√©Dono && bateBusca) {
                encontrados++;
                const dataProva = e.cabecalho.data_prova ? new Date(e.cabecalho.data_prova + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                const dataGeracao = e.data_geracao ? new Date(e.data_geracao).toLocaleDateString('pt-BR') : '---';

                listEl.innerHTML += `
                    <div class="exam-card-pro" onclick="selectExam('${e.id}')" style="
                        background: #ffffff;
                        border-radius: 16px;
                        border: 1px solid #e2e8f0;
                        padding: 24px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        flex-direction: column;
                        position: relative;
                        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
                    ">
                        <div style="font-size: 0.65rem; font-weight: 800; color: #3b82f6; text-transform: uppercase; margin-bottom: 8px;">
                             <i class="fas fa-university"></i> ${e.cabecalho.escola || 'INSTITUI√á√ÉO'}
                        </div>
                        
                        <h3 style="font-size: 1.2rem; color: #1e293b; font-weight: 800; margin: 0 0 15px 0; line-height: 1.2;">
                            ${disciplina}
                        </h3>

                        <div style="background: #f8fafc; padding: 12px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #f1f5f9;">
                            <div style="font-size: 0.85rem; color: #475569; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-chalkboard-teacher" style="color: #3b82f6;"></i>
                                <strong>${professorBD}</strong>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.8rem; color: #64748b; margin-bottom: 15px;">
                            <span><i class="fas fa-users" style="width: 14px;"></i> ${e.cabecalho.turma}</span>
                            <span><i class="fas fa-clock" style="width: 14px;"></i> ${e.cabecalho.turno}</span>
                            <span><i class="fas fa-calendar-alt" style="width: 14px;"></i> ${dataProva}</span>
                            <span><i class="fas fa-layer-group" style="width: 14px;"></i> ${e.cabecalho.periodo}</span>
                        </div>

                        <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
                            <small style="color: #94a3b8; font-size: 0.7rem;">Criada: ${dataGeracao}</small>
<span 
    onclick="setTimeout(() => { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }, 300);" 
    style="color: #3b82f6; font-weight: 700; font-size: 0.75rem; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;"
>
    GERENCIAR <i class="fas fa-arrow-right"></i>
</span>                        </div>
                    </div>
                `;
            }
        } catch (err) { console.error(err); }
    });

    // MENSAGEM DE ERRO PROFISSIONAL
    if (encontrados === 0) {
        listEl.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                <div style="background: #f1f5f9; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <i class="fas fa-folder-open" style="font-size: 2rem; color: #cbd5e1;"></i>
                </div>
                <h3 style="color: #1e293b; margin-bottom: 8px;">Nenhuma prova encontrada</h3>
                <p style="color: #64748b; font-size: 0.95rem;">N√£o localizamos registros para o professor <b style="color: #3b82f6;">${nomeLogado || 'logado'}</b>.</p>
            </div>`;
    }
}
    
    function selectExam(examId) {
        selectedExamId = examId;
        const prova = allExams[examId];
        if (prova) {
            document.getElementById('selected-exam-name').textContent = `Prova de ${prova.cabecalho.disciplina} (${prova.cabecalho.turma})`;
            document.getElementById('exam-details-view').style.display = 'block';
            document.getElementById('exam-preview').style.display = 'none';    
        }
    }

    
    window.openQuestionViewModal = function(questionId) {
        const q = allQuestions[questionId];
        if (!q) return;

        openModal('modal-question-view');
        
        document.getElementById('modal-question-id').value = questionId;
        document.getElementById('modal-question-title').textContent = `Visualizar/Editar Gabarito Quest√£o Q${q.id_sequencial}`;
        document.getElementById('modal-enunciado-text').textContent = q.enunciado.texto;
        
        const imgEl = document.getElementById('modal-enunciado-image');
        if (q.enunciado.midia) {
            imgEl.src = q.enunciado.midia;
            imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
        }
        
        const altList = document.getElementById('modal-alternatives-list');
        altList.innerHTML = '';
        
        if (q.tipo_questao === 'M√∫ltipla Escolha') {
            q.alternativas.forEach(alt => {
                const isCorrect = q.resposta_correta === alt.letra;
                let imgHtml = '';
                if (alt.midia) {
                    imgHtml = `<img src="${alt.midia}" class="question-image-preview" style="max-width: 150px;" alt="Imagem Alternativa ${alt.letra}">`;
                }
                
                altList.innerHTML += `
                    <li>
                        <label>
                            <input type="radio" name="new_correct_answer" value="${alt.letra}" ${isCorrect ? 'checked' : ''}>
                            <strong>(${alt.letra})</strong> ${alt.texto}    
                            ${imgHtml}
                        </label>
                    </li>
                `;
            });
            document.getElementById('modal-resposta-correta-atual').textContent = q.resposta_correta;
            document.getElementById('modal-gabarito-form').querySelector('button').style.display = 'block';
        } else {
            altList.innerHTML = `<p>Esta √© uma quest√£o <strong>Discursiva</strong>. N√£o h√° alternativa correta √∫nica para alterar.</p>`;
            document.getElementById('modal-gabarito-form').querySelector('button').style.display = 'none';
            document.getElementById('modal-resposta-correta-atual').textContent = 'Discursiva';
        }
    }

    async function saveNewAnswer() {
        const questionId = document.getElementById('modal-question-id').value;
        const newAnswer = document.querySelector('#modal-gabarito-form input[name="new_correct_answer"]:checked')?.value;
        
        if (!questionId || !newAnswer) {
            alert("Selecione uma nova resposta ou cancele.");
            return;
        }

        try {
            await database.ref(`banco_questoes/${questionId}`).update({ resposta_correta: newAnswer });
            allQuestions[questionId].resposta_correta = newAnswer;
            alert(`Gabarito da Quest√£o Q${allQuestions[questionId].id_sequencial} atualizado para: ${newAnswer}`);
            closeModal('modal-question-view');
            filterQuestions();  
        } catch (e) {
            alert("Erro ao salvar a nova resposta: " + e.message);
        }
    }

    window.openQuestionEditModal = function(questionId) {
        const q = allQuestions[questionId];
        if (!q) return;

        document.getElementById('edit-question-firebaseId').value = questionId;
        document.getElementById('edit-question-id-sequencial').value = q.id_sequencial;
        document.getElementById('modal-edit-question-title').textContent = `Editar Quest√£o Q${q.id_sequencial}`;

        document.getElementById('edit-modalidade').value = q.modalidade;
        document.getElementById('edit-componente').value = q.componente_curricular;
        document.getElementById('edit-habilidade').value = q.habilidade_bncc || '';
        document.getElementById('edit-tipo').value = q.tipo_questao;
        document.getElementById('edit-enunciado').value = q.enunciado.texto;
        document.getElementById('edit-resposta-correta').value = q.resposta_correta;
        
        document.getElementById('edit-linhas-discursiva').value = q.linhas_discursiva || 4;

        const imgEl = document.getElementById('edit-enunciado-image-preview');
        if (q.enunciado.midia) {
            imgEl.src = q.enunciado.midia;
            imgEl.style.display = 'block';
        } else {
            imgEl.src = '';
            imgEl.style.display = 'none';
        }

        setupEditAlternativeInputs(q);
        toggleEditAlternatives(q.tipo_questao);
        openModal('modal-question-edit');
    }

    function setupEditAlternativeInputs(question) {
        const container = document.getElementById('edit-alternatives-inputs');
        container.innerHTML = '';
        const isMultipleChoice = question.tipo_questao === 'M√∫ltipla Escolha';

        ALTERNATIVE_LETTERS.forEach((letra, index) => {
            const alt = question.alternativas ? question.alternativas.find(a => a.letra === letra) || { texto: '', midia: '' } : { texto: '', midia: '' };
            
            let imagePreviewHtml = '';
            if (alt.midia) {
                imagePreviewHtml = `<small>Imagem Atual:</small><img src="${alt.midia}" class="image-preview-edit" alt="Imagem Alt ${letra} Atual">`;
            }

            container.innerHTML += `
                <div>
                    <label for="edit-alt${letra}"><strong>${letra})</strong> Texto:</label>
                    <textarea id="edit-alt${letra}" rows="2" placeholder="Texto da alternativa ${letra}" ${isMultipleChoice ? 'required' : ''}>${alt.texto}</textarea>
                    
                    <label for="edit-img${letra}">M√≠dia ${letra} (Selecione um novo arquivo para substituir):</label>
                    <input type="file" id="edit-img${letra}" accept="image/*">
                    ${imagePreviewHtml}
                </div>
            `;
        });

        document.getElementById('edit-alternatives-section').style.display = isMultipleChoice ? 'block' : 'none';
    }

    function toggleAlternatives(tipo) {
        document.getElementById('alternatives-section').style.display =  
            tipo === 'M√∫ltipla Escolha' ? 'block' : 'none';
        document.getElementById('linhas-discursiva-group').style.display =
            tipo === 'Discursiva' ? 'block' : 'none';
    }
    
    function toggleEditAlternatives(tipo) {
        const isMultipleChoice = tipo === 'M√∫ltipla Escolha';
        document.getElementById('edit-alternatives-section').style.display = isMultipleChoice ? 'block' : 'none';
        document.getElementById('edit-linhas-discursiva-group').style.display =
            tipo === 'Discursiva' ? 'block' : 'none';

        ALTERNATIVE_LETTERS.forEach(letra => {
            const textarea = document.getElementById(`edit-alt${letra}`);
            if (textarea) textarea.required = isMultipleChoice;
        });
    }
    
    async function handleEditQuestionSave() {
        const messageEl = document.getElementById('question-edit-message');
        messageEl.innerHTML = `<div class="alert-info"><i class="fas fa-sync fa-spin"></i> Salvando e atualizando uploads...</div>`;
        
        const questionId = document.getElementById('edit-question-firebaseId').value;
        const originalQuestion = allQuestions[questionId];

        try {
            const newEnunciadoFile = document.getElementById('edit-enunciado-imagem').files[0];
            let enunciadoUrl = originalQuestion.enunciado.midia || "";
            if (newEnunciadoFile) {
                enunciadoUrl = await uploadFileToImgBB(newEnunciadoFile);
            }

            const tipo = document.getElementById('edit-tipo').value;
            const linhasDiscursiva = tipo === 'Discursiva' ? parseInt(document.getElementById('edit-linhas-discursiva').value) : 0;
            
            const novasAlternativas = [];
            
            if (tipo === 'M√∫ltipla Escolha') {
                for (const letra of ALTERNATIVE_LETTERS) {
                    const altText = document.getElementById(`edit-alt${letra}`).value;
                    const altFile = document.getElementById(`edit-img${letra}`).files[0];
                    
                    const originalAlt = originalQuestion.alternativas.find(a => a.letra === letra);
                    let midiaUrl = originalAlt ? originalAlt.midia : "";
                    
                    if (altFile) {
                        midiaUrl = await uploadFileToImgBB(altFile);
                    }
                    
                    novasAlternativas.push({
                        letra: letra,
                        texto: altText,
                        midia: midiaUrl
                    });
                }
            }

            const dadosAtualizados = {
                modalidade: document.getElementById('edit-modalidade').value,
                componente_curricular: document.getElementById('edit-componente').value,
                habilidade_bncc: document.getElementById('edit-habilidade').value,
                enunciado: { texto: document.getElementById('edit-enunciado').value, midia: enunciadoUrl },
                tipo_questao: tipo,
                alternativas: novasAlternativas,
                resposta_correta: tipo === 'M√∫ltipla Escolha' ? document.getElementById('edit-resposta-correta').value : "Discursiva",
                linhas_discursiva: linhasDiscursiva,
                data_edicao: new Date().toISOString()
            };

            await database.ref(`banco_questoes/${questionId}`).update(dadosAtualizados);
            
            Object.assign(allQuestions[questionId], dadosAtualizados);
            
            messageEl.innerHTML = `<div class="alert-success"><i class="fas fa-check-circle"></i> Quest√£o Q${originalQuestion.id_sequencial} salva com sucesso!</div>`;
            
            filterQuestions();
            setTimeout(() => closeModal('modal-question-edit'), 1500);

        } catch (error) {
            console.error("Erro ao editar quest√£o:", error);
            messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-exclamation-circle"></i> Erro ao salvar a edi√ß√£o: ${error.message}</div>`;
        }
    }
    
    function openEditExamModal() {
        if (!selectedExamId) return;
        const prova = allExams[selectedExamId];
        
        document.getElementById('modal-edit-exam-name').textContent = prova.cabecalho.disciplina;
        document.getElementById('edit-escola').value = prova.cabecalho.escola;
        document.getElementById('edit-turma').value = prova.cabecalho.turma;
        document.getElementById('edit-professor').value = prova.cabecalho.professor;
        document.getElementById('edit-duracao').value = prova.cabecalho.duracao;
        document.getElementById('edit-data-prova').value = prova.cabecalho.data_prova;  

        openModal('modal-edit-exam');
    }

    async function handleEditExamSave() {
        const messageEl = document.getElementById('edit-exam-message');
        const updates = {
            escola: document.getElementById('edit-escola').value,
            turma: document.getElementById('edit-turma').value,
            professor: document.getElementById('edit-professor').value,
            duracao: document.getElementById('edit-duracao').value,
            data_prova: document.getElementById('edit-data-prova').value,
        };
        
        try {
            await database.ref(`provas/${selectedExamId}/cabecalho`).update(updates);
            
            Object.assign(allExams[selectedExamId].cabecalho, updates);
            updateExamListView();
            
            messageEl.innerHTML = `<div class="alert-success"><i class="fas fa-check"></i> Prova atualizada com sucesso!</div>`;
            setTimeout(() => closeModal('modal-edit-exam'), 1500);
        } catch (e) {
            messageEl.innerHTML = `<div class="alert-error"><i class="fas fa-exclamation-circle"></i> Erro ao salvar edi√ß√£o: ${e.message}</div>`;
        }
    }
    
    async function deleteExam() {
        if (!selectedExamId || !confirm("Tem certeza que deseja EXCLUIR esta prova? Esta a√ß√£o √© irrevers√≠vel.")) return;
        try {
            await database.ref(`provas/${selectedExamId}`).remove();
            delete allExams[selectedExamId];
            selectedExamId = null;
            updateExamListView();
            alert("Prova exclu√≠da com sucesso.");
        } catch (e) {
            alert("Erro ao excluir prova: " + e.message);
        }
    }

    function getAntiFraudGarbage() {
        const randomString = Math.random().toString(36).substring(2, 8);
        return `<span class="af-garbage">${randomString}</span>`;
    }

    function obfuscateText(text) {
        if (!text) return "";
        let newText = "";
        let chars = text.split("");
        
        for (let i = 0; i < chars.length; i++) {
            newText += chars[i];
            if (Math.random() > 0.6) {
                newText += getAntiFraudGarbage();
            }
        }
        return newText;
    }

function gerarHTMLProva(prova) {
    const cab = prova.cabecalho;
    
    // 1. CORRE√á√ÉO DA ORDEM DA DATA (De AAAA-MM-DD para DD/MM/AAAA)
    let dataFormatadaBR = '__/__/____';
    if (cab.data_prova && cab.data_prova.includes('-')) {
        const [ano, mes, dia] = cab.data_prova.split('-');
        dataFormatadaBR = `${dia}/${mes}/${ano}`;
    } else if (cab.data_prova) {
        dataFormatadaBR = cab.data_prova; 
    }
    
    // 2. L√ìGICA DE LOGO: PRIORIDADE TOTAL AO LINK DIRETO DO BANCO
    let logoSrc = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="#f8fafc"/><text x="50" y="55" font-family="Arial" font-size="12" fill="#cbd5e1" text-anchor="middle">LOGO</text></svg>';
    
    // Se houver logo no objeto 'cab' (link direto do Firebase), use-a primeiro
    if (cab && cab.logo && cab.logo.trim() !== '') {
        logoSrc = cab.logo;
    } 
    // Se n√£o houver no banco, mas houver na global (upload recente), use a global
    else if (window.logoBase64Final && window.logoBase64Final.trim() !== '') {
        logoSrc = window.logoBase64Final;
    }

    let htmlContent = `
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
            .exam-body { font-family: 'Inter', sans-serif; color: #1a202c; font-size: 11pt; line-height: 1.3; padding: 0; margin: 0; }
            .header-container { display: flex; border: 1pt solid #2563eb; margin-bottom: 6px; border-radius: 4px; overflow: hidden; width: 100%; }
            .header-logo { width: 90px; display: flex; align-items: center; justify-content: center; padding: 4px; border-right: 1pt solid #2563eb; background: #fff; }
            .header-logo img { max-width: 80px; max-height: 70px; object-fit: contain; }
            .header-content { flex: 1; display: flex; flex-direction: column; }
            .school-name { background: #2563eb; color: white; padding: 3px; text-align: center; font-weight: 700; font-size: 10.5pt; text-transform: uppercase; }
            .header-grid { display: grid; grid-template-columns: 2.5fr 0.8fr 0.8fr; }
            .cell { border-right: 0.5pt solid #e2e8f0; border-bottom: 0.5pt solid #e2e8f0; padding: 3px 6px; font-size: 8.5pt; display: flex; align-items: center; }
            .label-text { font-weight: 700; font-size: 7pt; color: #3b82f6; text-transform: uppercase; margin-right: 4px; }
            .icon-color { color: #f59e0b; margin-right: 3px; font-size: 7.5pt; }
            .cell-nota { background: #f8fafc; height: 45px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding-top: 4px; }
            .nota-brackets { font-size: 14pt; color: #1e40af; margin-top: 2px; }
            .questions-wrapper { column-count: ${prova.layout_colunas || 1}; column-gap: 15px; margin-top: 8px; }
            .question-item { break-inside: avoid; margin-bottom: 12px; padding-top: 6px; border-top: 0.5pt solid #f1f5f9; }
            .q-title { font-weight: 700; font-size: 10.5pt; color: #1e40af; display: flex; align-items: center; gap: 4px; }
            .q-habilidade { font-size: 7pt; color: #0d9488; background: #f0fdfa; padding: 1px 4px; border-radius: 3px; font-weight: 600; }
            .writing-line { border-bottom: 0.5pt solid #cbd5e1; height: 22px; width: 100%; }
            .instructions-text { font-size: 8pt; padding: 4px 8px; border-left: 3pt solid #f59e0b; background: #fffbeb; margin-bottom: 8px; border-radius: 0 3px 3px 0; }
            .alt-item { display: flex; gap: 6px; font-size: 10.5pt; margin-bottom: 3px; }
            .alt-letter { font-weight: 700; color: #2563eb; min-width: 18px; }
            @media print {
                .school-name { background: #2563eb !important; -webkit-print-color-adjust: exact; }
                .cell-nota { background: #f8fafc !important; -webkit-print-color-adjust: exact; }
                .instructions-text { background: #fffbeb !important; -webkit-print-color-adjust: exact; }
            }
        </style>

        <div class="exam-body">
            <div class="header-container">
                <div class="header-logo"><img src="${logoSrc}"></div>
                <div class="header-content">
                    <div class="school-name">${cab.escola}</div>
                    <div class="header-grid">
                        <div class="cell"><span class="label-text"><i class="fas fa-user icon-color"></i> ALUNO:</span> <span style="border-bottom: 0.5pt solid #ccc; flex:1; height: 12px;"></span></div>
                        <div class="cell"><span class="label-text">N¬∫:</span> <span style="border-bottom: 0.5pt solid #ccc; flex:1; height: 12px;"></span></div>
                        <div class="cell" style="border-right:none;"><span class="label-text">SALA:</span> <span style="border-bottom: 0.5pt solid #ccc; flex:1; height: 12px;"></span></div>
                        
                        <div class="cell" style="border-bottom:none;"><span class="label-text">DISC:</span> <strong>${cab.disciplina}</strong></div>
                        <div class="cell" style="border-bottom:none;"><span class="label-text">TURMA:</span> <strong>${cab.turma}</strong></div>
                        <div class="cell" style="border-bottom:none; border-right:none;"><span class="label-text">DATA:</span> <strong>${dataFormatadaBR}</strong></div>
                    </div>
                </div>
            </div>

            <div class="header-container" style="margin-top: -7px; border-top: none;">
                <div class="cell" style="flex: 2; border-bottom: none; border-right: 1pt solid #2563eb;"><span class="label-text">PROF:</span> <strong>${cab.professor}</strong></div>
                <div class="cell" style="flex: 1; border-bottom: none; border-right: 1pt solid #2563eb;"><span class="label-text">PER√çODO:</span> <strong>${cab.periodo || '---'}</strong></div>
                <div class="cell cell-nota" style="flex: 0.8; border-bottom: none; border-right: none;">
                    <span class="label-text">NOTA FINAL</span>
                    <div class="nota-brackets">( &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )</div>
                </div>
            </div>

            <div class="instructions-text"><strong>Instru√ß√µes:</strong> ${prova.instrucoes_gerais}</div>
            <div class="questions-wrapper">
    `;

    prova.questoes_detalhes.forEach((q, index) => {
        htmlContent += `
            <div class="question-item">
                <div class="q-header" style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span class="q-title">QUEST√ÉO ${index + 1}</span>
                    <span class="q-habilidade">${q.habilidade_bncc || ''}</span>
                </div>
                <div class="q-text" style="margin-bottom:8px;">${q.enunciado.texto}</div>
        `;
        
        if (q.enunciado.midia) {
            htmlContent += `<div style="text-align:center; margin: 6px 0;"><img src="${q.enunciado.midia}" style="max-width: 98%; max-height: 200px; border-radius: 4px;"></div>`;
        }

        if (q.tipo_questao === 'M√∫ltipla Escolha') {
            q.alternativas.forEach(alt => {
                htmlContent += `<div class="alt-item"><span class="alt-letter">${alt.letra})</span><span style="flex:1;">${alt.texto}</span></div>`;
            });
        } else {
            for (let i = 0; i < (parseInt(q.linhas_discursiva) || 4); i++) {
                htmlContent += '<div class="writing-line"></div>';
            }
        }
        htmlContent += `</div>`;
    });

    htmlContent += `</div></div>`;
    return htmlContent;
}
function visualizarProvaDetalhe() {
    if (!selectedExamId || !allExams[selectedExamId]) return;
    const prova = allExams[selectedExamId];
    const printContentEl = document.getElementById('exam-content-print');
    if (!printContentEl) return;
    
    if (prova.cabecalho && prova.cabecalho.logo) {
        window.logoBase64Final = prova.cabecalho.logo;
    }

    printContentEl.innerHTML = gerarHTMLProva(prova);
    document.getElementById('exam-preview').style.display = 'block';
}

    function exportarProva(tipo) {
        if (!selectedExamId) return;
        const prova = allExams[selectedExamId];
        
        const html = gerarHTMLProva(prova);
        
        const printArea = document.getElementById('print-area-container');
        
        printArea.innerHTML = html;
        
        printArea.style.setProperty('--print-col-count', prova.layout_colunas || 1);

        window.print();
        
        setTimeout(() => {
            printArea.innerHTML = '';
        }, 500);
        
        alert(`‚úÖ Prova Gerada com Prote√ß√£o Anti-Fraude!\n\nSe tentarem converter este PDF para Word, o texto ficar√° ileg√≠vel devido √† criptografia visual implementada.`);
    }
    
    function baixarGabarito() {
        if (!selectedExamId) return;
        const prova = allExams[selectedExamId];
        const content = prova.gabarito;
        
        const filename = `Gabarito_${prova.cabecalho.disciplina}_${new Date().toISOString().substring(0, 10)}.txt`;
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
        alert("Gabarito baixado em TXT.");
    }

    async function updateDashboardIndicators() {
        try {
            const questaoSnapshot = await database.ref('banco_questoes').once('value');
            const provaSnapshot = await database.ref('provas').once('value');
            const userSnapshot = await database.ref('usuarios').once('value');

            const totalQuestoes = questaoSnapshot.exists() ? Object.keys(questaoSnapshot.val()).length : 0;
            const totalProvas = provaSnapshot.exists() ? Object.keys(provaSnapshot.val()).length : 0;
            
            const users = userSnapshot.val();
            const usersArray = users ? Object.values(users) : [];
            const active = usersArray.filter(u => u.status === 'Aprovado');
            const totalPendentes = usersArray.filter(u => u.status === 'Pendente').length;
            const totalPadrao = active.filter(u => u.role === 'Padr√£o').length;
            const totalAdm = active.filter(u => u.role === 'ADM').length;
            
            document.getElementById('dash-total-questoes').textContent = totalQuestoes;
            document.getElementById('dash-total-provas').textContent = totalProvas;
            document.getElementById('dash-total-padrao').textContent = totalPadrao;
            document.getElementById('dash-total-adm').textContent = totalAdm;
            document.getElementById('dash-total-pendentes').textContent = totalPendentes;
        } catch (e) {
            console.error("Erro ao carregar indicadores:", e);
        }
    }

    function loadHeaderConfig() {
        try {
            const config = JSON.parse(localStorage.getItem('header_config'));
            if (config) {
                document.getElementById('cabecalho-escola').value = config.escola || '';
                document.getElementById('cabecalho-professor').value = CURRENT_USER?.nome || '';  
                document.getElementById('cabecalho-turma').value = config.turma || '';
                document.getElementById('cabecalho-periodo').value = config.periodo || '1¬∫ PER√çODO';
                document.getElementById('cabecalho-turno').value = config.turno || 'Matutino';
            }
        } catch (e) {
            console.warn("Nenhuma configura√ß√£o de cabe√ßalho encontrada ou inv√°lida.");
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupAlternativeInputs();
        document.getElementById('cabecalho-data-prova').value = new Date().toISOString().substring(0, 10);
        
        toggleAlternatives('M√∫ltipla Escolha');
    });
    // Adicione isso na √∫ltima linha da fun√ß√£o que carrega a lista de provas
const scrollToEnd = () => {
    window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth'
    });
};

// Chamada opcional se quiser que des√ßa sozinho ao abrir a p√°gina
// scrollToEnd();
</script>
</body>
</html>
